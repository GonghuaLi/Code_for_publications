---
title: "Analyze cell senescence vmax"
author: "Gong-Hua Li"
date: "2024-1-02"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
---

# 1. setwd and env

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = 'E:/iHuman/projects/Cell_line_aging')
setwd('E:/iHuman/projects/Cell_line_aging')
#knitr::opts_knit$set(root.dir = '/home/ligh/projects/X/projects/Cell_aging') # in linux
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
#SYBIL_SETTINGS("SOLVER", "cplexAPI")
```

```{r}
options(warn = -1)
library(pheatmap)
library(rGPMM)
library(sybil)
library(ggsci)
library(ggplot2)
library(GEOquery)
library(dplyr)
library(data.table)
library(EnhancedVolcano)
```

```{r}
geneheader = file2frame('./data/Homo_sapiens.GRCh38.99.ensemble_symbol_biotype.txt')
rownames(geneheader) = geneheader$gene_id


list_element_select <- function(x, rname,cname){
  out = matrix('',length(rname),length(x))
  for(i in 1:length(x)){
    out[,i] = unlist(x[[i]][rname,cname])
  }
  colnames(out) = names(x)
  rownames(out) = rname
  return(out)
}

get_status_from_ko <- function(KOeffects){
  ko = KOeffects
  tnames = names(ko)
  #del duplicated
  dupid = unique(tnames[duplicated(tnames)])
  if (length(dupid) > 0) {
    for(i in 1:length(dupid)){
     idx = which(tnames == dupid[i])
     tmpn = length(idx)
      if (any( ko[idx] > 0 ) & any(ko[idx] < 0)){
        ko[idx] = NA
      }else if(ko[idx[1]] > 0){
        ko[idx[-1]] = NA
     }else if(ko[idx[tmpn]] < 0){
       ko[idx[-tmpn]] = NA
     }else{
       ko[idx[-1]] = NA
      }
    }
    ko = ko[-which(is.na(ko))]
  }
  
  tsd = sd(ko)
  tpvalue = rep(1,length(ko))
  for(i in 1:length(tpvalue)){
    xx = ko[i]
    if(xx < 0){
         tpvalue[i] = pnorm(xx,0,tsd)
    }else{
        tpvalue[i] = 1-pnorm(xx,0,tsd)
    }
  }
  tfdr = p.adjust(tpvalue,method = 'fdr')
  out = data.frame(ID = names(ko),
                   ES = ko,
                   Pvalue = tpvalue,
                   FDR = tfdr)
  rownames(out) = out$ID
  return(out)
}


get_consist_mets <- function(ma){
    tmpout = ma
    tmpout$direct = sign(tmpout$ES)* (ma$FDR < 0.05 )
    tmpout$met_name = substr(tmpout$ID,1,nchar(tmpout$ID)-3)
    uname = unique(tmpout$met_name[tmpout$direct != 0])
    tmpout$direct.v = tmpout$direct
    for(i in 1:length(uname)){
        tmpids = which(tmpout$met_name == uname[i])
        tmpn = length(tmpids)
        if (tmpn < 2) {next;}
        tmps = tmpout$direct[tmpids]
        if(any(tmps > 0) & any(tmps < 0)){
            tmpout$direct.v[tmpids] = 0
        }else if(tmps[1] > 0){
            tmpout$direct.v[tmpids[-1]] = 0
        }else if(tmps[tmpn]< 0){
            tmpout$direct.v[tmpids[-tmpn]] = 0
        }else{
            tmpout$direct.v[tmpids[-1]] = 0
        }
    }
    return(tmpout)
}


prepross_GPMM <- function(flux3,clin){
  #flux3 = outlist$fluxes_by_Vmax_cor
  flux3.annote = Recon3.annote
  idxx = rowMeans(abs(flux3))> 1e-6 & rowSums(abs(flux3)>0) > 0.1*ncol(flux3)

  flux3 = flux3[idxx,]
  flux3.abs = fillgaps_rowMin(abs(flux3))

  idbb = CVs(flux3.abs) > 1e-3
  flux3.abs = flux3.abs[idbb,]  
  flux3 = flux3[idbb,]  
  #remove invalid mcmc model
  idyy = flux3.abs['biomass_reaction',] > 1e-9 
  flux3.abs = flux3.abs[,idyy]
  flux3 = flux3[,idyy]

  flux3.log2= as.matrix(log2(flux3.abs+ 1e-6))
  flux3.annote = flux3.annote[rownames(flux3),]
  clin.v = clin[colnames(flux3),]
  out = list()
  out[['flux3']] = flux3
  out[['flux3.log2']] = flux3.log2
  out[['flux3.annote']] = flux3.annote
  out[['clin.v']] = clin.v
  return(out)
}

metaflux <- function(repFlux3vmax,repClin, 
                     meta.method = "FEM",tail = 'abs',parametric = TRUE){
  # set data
  flux3.log2 = list()

  allrxns = c()
  thenames = names(repClin)
  for(i in 1:length(thenames)){
    studyname = thenames[i]
    gpmmresult = prepross_GPMM(repFlux3vmax[[studyname]],repClin[[studyname]])
    allrxns = unique(c(allrxns,rownames(gpmmresult$flux3.log2)))
    flux3.log2[[i]] = gpmmresult$flux3.log2
  }
  flux3.AveExpr = matrix(0,length(allrxns),length(repClin))
  flux3.log2FC = matrix(0,length(allrxns),length(repClin))
  flux3.Pvalue = matrix(0,length(allrxns),length(repClin))
  flux3.FDR = matrix(0,length(allrxns),length(repClin))
  for(i in 1:length(thenames)){
    tmp = as.data.frame(flux3.log2[[i]])
    tmp = as.matrix(tmp[allrxns,])
    tmp[is.na(tmp)] = log2(1e-6)
    rownames(tmp) = allrxns
    tmpDEflux = DEGenes.simplified(tmp,catagory = repClin[[i]]$ageType == 'sen')
    flux3.log2[[i]] = tmp
    flux3.log2FC[,i] = tmpDEflux$log2FC
    flux3.Pvalue[,i] = tmpDEflux$Pvalue
    flux3.FDR[,i] = tmpDEflux$FDR
    flux3.AveExpr[,i]  =  tmpDEflux$AveExpr
  }
  colnames(flux3.AveExpr) = paste0('AveExpr_',thenames)
  colnames(flux3.log2FC) = paste0('log2FC_',thenames)
  colnames(flux3.Pvalue) = paste0('Pvalue_',thenames)
  colnames(flux3.FDR) = paste0('FDR_',thenames)
  
  #run metaDE
  data = flux3.log2
  label = list()
  K <- length(data)
  for(i in 1:length(repClin)){
    label[[i]] = repClin[[i]]$ageType
  }
  clin.data <- lapply(label, function(x) {data.frame(x)} )
  for (k in 1:length(clin.data)){
  colnames(clin.data[[k]]) <- "label"
  }
  select.group <- c('sen','pro')
  ref.level <- "pro"
  data.type <- "continuous"
  ind.method <- rep('limma',length(data))
  resp.type <- "twoclass"
  paired <- rep(FALSE,length(data))
  meta.res <- MetaDE(data=data,clin.data = clin.data,
                    data.type=data.type,resp.type = resp.type,
                    response='label',
                    ind.method=ind.method, meta.method=meta.method,
                    select.group = select.group, ref.level=ref.level,
                    REM.type = 'HS',
                    paired=paired,tail=tail,parametric=parametric)
  #
  out = data.frame(ID = allrxns,stringsAsFactors = F,
                   MetaAveExpr = rowMeans(flux3.AveExpr),
                   Metalog2FC = rowMeans(flux3.log2FC),
                   MetaPvalue = as.vector(meta.res$meta.analysis$pval),
                   MetaFDR = as.vector(meta.res$meta.analysis$FDR),
                   MetaZvalue = as.vector(meta.res$meta.analysis$zval))
  out$MetaFDR[is.na(out$MetaFDR)] = 1
  out$MetaPvalue[is.na(out$MetaPvalue)] = 1
  out$MetaZvalue[is.na(out$MetaZvalue)] = 0
  
  out = cbind(out,flux3.log2FC)
  out = cbind(out,flux3.Pvalue)
  out = cbind(out,flux3.FDR)
  flux3.annote = Recon3.annote
  out = cbind(out,flux3.annote[allrxns,])
  rownames(out) = allrxns
  return(out)
  
}

metaGene <- function(repExpr,repClin, 
                     meta.method = "FEM",tail = 'abs',parametric = TRUE){
  # set data
  flux3.log2 = list()

  allrxns = c()
  thenames = names(repClin)
  for(i in 1:length(thenames)){
    studyname = thenames[i]
    expr.log2 = log2(repExpr[[studyname]]+1e-6)
    allrxns = unique(c(allrxns,rownames(expr.log2)))
    flux3.log2[[i]] = expr.log2
  }
  flux3.AveExpr = matrix(0,length(allrxns),length(repClin))
  flux3.log2FC = matrix(0,length(allrxns),length(repClin))
  flux3.Pvalue = matrix(0,length(allrxns),length(repClin))
  flux3.FDR = matrix(0,length(allrxns),length(repClin))
  for(i in 1:length(thenames)){
    tmp = as.data.frame(flux3.log2[[i]])
    tmp = as.matrix(tmp[allrxns,])
    tmp[is.na(tmp)] = log2(1e-6)
    rownames(tmp) = allrxns
    tmpDEflux = DEGenes.simplified(tmp,catagory = repClin[[i]]$ageType == 'sen')
    flux3.log2[[i]] = tmp
    flux3.log2FC[,i] = tmpDEflux$log2FC
    flux3.Pvalue[,i] = tmpDEflux$Pvalue
    flux3.FDR[,i] = tmpDEflux$FDR
    flux3.AveExpr[,i]  =  tmpDEflux$AveExpr
  }
  colnames(flux3.AveExpr) = paste0('AveExpr_',thenames)
  colnames(flux3.log2FC) = paste0('log2FC_',thenames)
  colnames(flux3.Pvalue) = paste0('Pvalue_',thenames)
  colnames(flux3.FDR) = paste0('FDR_',thenames)
  
  #run metaDE
  data = flux3.log2
  label = list()
  K <- length(data)
  for(i in 1:length(repClin)){
    label[[i]] = repClin[[i]]$ageType
  }
  clin.data <- lapply(label, function(x) {data.frame(x)} )
  for (k in 1:length(clin.data)){
  colnames(clin.data[[k]]) <- "label"
  }
  select.group <- c('sen','pro')
  ref.level <- "pro"
  data.type <- "continuous"
  ind.method <- rep('limma',length(data))
  resp.type <- "twoclass"
  paired <- rep(FALSE,length(data))
  meta.res <- MetaDE(data=data,clin.data = clin.data,
                    data.type=data.type,resp.type = resp.type,
                    response='label',
                    ind.method=ind.method, meta.method=meta.method,
                    select.group = select.group, ref.level=ref.level,
                    REM.type = 'HS',
                    paired=paired,tail=tail,parametric=parametric)
  #
  out = data.frame(ID = allrxns,stringsAsFactors = F,
                   MetaAveExpr = rowMeans(flux3.AveExpr),
                   Metalog2FC = rowMeans(flux3.log2FC),
                   MetaPvalue = as.vector(meta.res$meta.analysis$pval),
                   MetaFDR = as.vector(meta.res$meta.analysis$FDR),
                   MetaZvalue = as.vector(meta.res$meta.analysis$zval))
  out$MetaFDR[is.na(out$MetaFDR)] = 1
  out$MetaPvalue[is.na(out$MetaPvalue)] = 1
  out$MetaZvalue[is.na(out$MetaZvalue)] = 0
  
  out = cbind(out,flux3.log2FC)
  out = cbind(out,flux3.Pvalue)
  out = cbind(out,flux3.FDR)
  #flux3.annote = Recon3.annote
  #out = cbind(out,flux3.annote[allrxns,])
  rownames(out) = allrxns
  return(out)
  
}
```

# 2. load data

```{r}
load('./data/cell_line_data/replication_senescence_data_v20231207.Rdata')
load('./data/cell_line_data/IRradiation_senescence_data_v20231207.Rdata')
load('./data/cell_line_data/ROS_senescence_data_v20231207.Rdata')
load('./data/cell_line_data/Oncogene_senescence_data_v20231207.Rdata')
```

# 3. filtering studies

## 3.1 replication data

```{r}
library(MetaDE)

metaRep = metaGene(repExpr,repClin,meta.method = 'FEM')

xx = paste0('log2FC_',names(repClin))
fcs = metaRep[,xx]
pca_after = prcomp(t(fcs),cor = F)
outerlines = names(repClin)[is.outliner(pca_after$x[,1])]
print(outerlines)
repExpr[outerlines] =NULL
repFlux3vmax[outerlines] =NULL
repClin[outerlines] =NULL
repStudy = repStudy[names(repClin),]


```

## 3.2 ROS

```{r}
metaROS = metaGene(ROSExpr,ROSClin,meta.method = 'FEM')

xx = paste0('log2FC_',names(ROSClin))
fcs = metaROS[,xx]
pca_after = prcomp(t(fcs),cor = F)
outerlines = names(ROSClin)[is.outliner(pca_after$x[,1])]
print(outerlines)
ROSExpr[outerlines] =NULL
ROSFlux3vmax[outerlines] =NULL
ROSClin[outerlines] =NULL
ROSStudy = ROSStudy[names(ROSClin),]
```

## 3.3 IR

```{r}
metaIR = metaGene(IRExpr,IRClin,meta.method = 'FEM')

xx = paste0('log2FC_',names(IRClin))
fcs = metaIR[,xx]
pca_after = prcomp(t(fcs),cor = F)
outerlines = names(IRClin)[is.outliner(pca_after$x[,1])]
print(outerlines)
IRExpr[outerlines] =NULL
IRFlux3vmax[outerlines] =NULL
IRClin[outerlines] =NULL
IRStudy = IRStudy[names(IRClin),]
```

```{r}
#write studies suppementary S1
allstudies = rbind(repStudy,ROSStudy)
allstudies = rbind(allstudies,IRStudy)
allstudies = rbind(allstudies,OncoStudy)
writetxt_forGPMM(allstudies,'./data/all_studies_tableS1.txt')

```

## 3.4 Oncogene

```{r}
metaOnco = metaGene(OncoExpr,OncoClin,meta.method = 'FEM')

xx = paste0('log2FC_',names(OncoClin))
fcs = metaOnco[,xx]
pca_after = prcomp(t(fcs),cor = F)
outerlines = names(OncoClin)[is.outliner(pca_after$x[,1])]
print(outerlines)
OncoExpr[outerlines] =NULL
OncoFlux3vmax[outerlines] =NULL
OncoClin[outerlines] =NULL
OncoStudy = OncoStudy[names(OncoClin),]
```

# 4. Figure 1: Study design and data overview

## 4.1 Figure 1A: study design

## 4.2 Figure 1B: Data collection

## 4.3 Figure 1C: Flux distribution

```{r}
mypal = pal_npg()(10)
mypal
scales::show_col(mypal)
```

```{r}
#rep
thenames = names(repFlux3vmax)
studynames = rownames(repStudy)
for(i in 1:length(thenames)){
  studyname = thenames[i]
  tmplist = prepross_GPMM(repFlux3vmax[[studyname]],repClin[[studyname]])
  tmp = as.data.frame(tmplist$flux3.log2)
  tmpclin_org = repClin[[studyname]]
  studyinfo = strsplit(studyname,'_')[[1]]
  tmpclin = data.frame(ID = rownames(tmpclin_org),stringsAsFactors = F,
                       senType = rep('rep',nrow(tmpclin_org)),
                       celltype = rep(studyinfo[1],nrow(tmpclin_org)),
                       GEOID = rep(studyinfo[2],nrow(tmpclin_org)),
                       studyID = rep(studynames[i],nrow(tmpclin_org)),
                       ageType = tmpclin_org$ageType)
  
  if (i ==1){
    flux3.log2 =tmp
    flux3.log2.clin = tmpclin
  }else{
    vids  = union(rownames(flux3.log2),rownames(tmp))
    flux3.log2 = cbind(flux3.log2[vids,],tmp[vids,])
    rownames(flux3.log2) = vids
    flux3.log2.clin = rbind(flux3.log2.clin,tmpclin)
  }
}

#ROS
thenames = names(ROSFlux3vmax)
studynames = rownames(ROSStudy)
for(i in 1:length(thenames)){
  studyname = thenames[i]
  tmplist = prepross_GPMM(ROSFlux3vmax[[studyname]],ROSClin[[studyname]])
  tmp = as.data.frame(tmplist$flux3.log2)
  vids  = union(rownames(flux3.log2),rownames(tmp))
  flux3.log2 = cbind(flux3.log2[vids,],tmp[vids,])
  rownames(flux3.log2) = vids
  studyinfo = strsplit(studyname,'_')[[1]]
  tmpclin_org = ROSClin[[studyname]]
  tmpclin = data.frame(ID = rownames(tmpclin_org),stringsAsFactors = F,
                       senType = rep('ROS',nrow(tmpclin_org)),
                       celltype = rep(studyinfo[1],nrow(tmpclin_org)),
                       GEOID = rep(studyinfo[2],nrow(tmpclin_org)),
                       studyID = rep(studynames[i],nrow(tmpclin_org)),
                       ageType = tmpclin_org$ageType)
  flux3.log2.clin = rbind(flux3.log2.clin,tmpclin)
}

#IR
thenames = names(IRFlux3vmax)
studynames = rownames(IRStudy)
for(i in 1:length(thenames)){
  studyname = thenames[i]
  tmplist = prepross_GPMM(IRFlux3vmax[[studyname]],IRClin[[studyname]])
  tmp = as.data.frame(tmplist$flux3.log2)
  vids  = union(rownames(flux3.log2),rownames(tmp))
  flux3.log2 = cbind(flux3.log2[vids,],tmp[vids,])
  rownames(flux3.log2) = vids
  studyinfo = strsplit(studyname,'_')[[1]]
  tmpclin_org = IRClin[[studyname]]
  tmpclin = data.frame(ID = rownames(tmpclin_org),stringsAsFactors = F,
                       senType = rep('IR',nrow(tmpclin_org)),
                       celltype = rep(studyinfo[1],nrow(tmpclin_org)),
                       GEOID = rep(studyinfo[2],nrow(tmpclin_org)),
                       studyID = rep(studynames[i],nrow(tmpclin_org)),
                       ageType = tmpclin_org$ageType)
  flux3.log2.clin = rbind(flux3.log2.clin,tmpclin)
}

#Onco
thenames = names(OncoFlux3vmax)
studynames = rownames(OncoStudy)
for(i in 1:length(thenames)){
  studyname = thenames[i]
  tmplist = prepross_GPMM(OncoFlux3vmax[[studyname]],OncoClin[[studyname]])
  tmp = as.data.frame(tmplist$flux3.log2)
  vids  = union(rownames(flux3.log2),rownames(tmp))
  flux3.log2 = cbind(flux3.log2[vids,],tmp[vids,])
  rownames(flux3.log2) = vids
  studyinfo = strsplit(studyname,'_')[[1]]
  tmpclin_org = OncoClin[[studyname]]
  tmpclin = data.frame(ID = rownames(tmpclin_org),stringsAsFactors = F,
                       senType = rep('Onco',nrow(tmpclin_org)),
                       celltype = rep(studyinfo[1],nrow(tmpclin_org)),
                       GEOID = rep(studyinfo[2],nrow(tmpclin_org)),
                       studyID = rep(studynames[i],nrow(tmpclin_org)),
                       ageType = tmpclin_org$ageType)
  flux3.log2.clin = rbind(flux3.log2.clin,tmpclin)
}
aamodel = removeRxns(Recon3,setdiff(Recon3$rxns,rownames(flux3.log2)))

print(c('numrxns: ',length(aamodel$rxns)))
print(c('nummets: ',length(aamodel$mets)))
print(c('numgenes: ',length(aamodel$geneSymbol)))

#rownames(flux3.log2.clin)= colnames(flux3.log2)

vid = rowSums(is.na(flux3.log2)) < ncol(flux3.log2)/2
flux3.log2  =flux3.log2[vid,]
flux3.abs = as.matrix(2^flux3.log2)
flux3.abs[is.na(flux3.abs)] = 0
flux3.abs = fillgaps_rowMin(flux3.abs)
flux3.log2.v = log2(flux3.abs)
#flux3.log2.v.comb = sva::ComBat(dat=flux3.log2.v, batch=flux3.log2.clin$studyID, mod=NULL, par.prior=F, prior.plots=FALSE)

#tpca = prcomp(t(flux3.log2.v.comb),cor = F)
tpca = prcomp(t(flux3.log2.v),cor = F)
percPCA = 100*summary(tpca)$importance

tmpdata = data.frame(pc1 = tpca$x[,1],
                     pc2 = tpca$x[,2])
tmpdata = cbind(tmpdata,flux3.log2.clin)
pdf('./Figures/Figure1/Figure1C_pca_sentype_nocombined.pdf',width = 8,height = 7)
ggplot(tmpdata,aes(pc1,pc2,color = celltype)) + #scale_color_aaas()+scale_fill_aaas()+
  geom_point(size = 3,aes(shape = senType))+lghplot.addtheme(size = 14,legend.position = 'right')+
  xlab(paste("PC1(",as.character(round(percPCA[2,1],1)),'%)',sep = ''))+
  ylab(paste("PC2(",as.character(round(percPCA[2,2],1)),'%)',sep = ''))+
  ggtitle('Overall flux distribution in different cell types')
dev.off()



```

## 4.4 Figure 1D biomass_reaction

```{r}
tmpdata = flux3.log2.clin
tmpdata$biomass_reaction = flux3.abs['biomass_reaction',]
#tmpdata$studyID = paste(tmpdata$senType,tmpdata$studyID,sep = '_')


data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}


tmpdataV = tmpdata[tmpdata$senType=='rep',]
df2 <- data_summary(tmpdataV, varname="biomass_reaction", 
                    groupnames=c("ageType", "studyID"))

p<- ggplot(df2, aes(x=studyID, y=biomass_reaction, fill=ageType)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) + #geom_point(aes(group = ageType))+
  geom_errorbar(aes(ymin=biomass_reaction-sd, ymax=biomass_reaction+sd), width=.5,
                 position=position_dodge(.9)) +#+ #scale_color_aaas()+scale_fill_aaas()+
   labs(title="Replication senescence", x="", y = "biomass_reaction(mmol/L/min)")+
   theme_classic() + scale_color_npg()+scale_fill_npg() + 
   lghplot.addtheme(size = 12,sizex =10,sizey = 10,hjust = T,legend.position = 'top')
pdf('./Figures/Figure1/Figure1D_biomass_rep1.pdf',width = 6,height = 4)
 print(p)
dev.off()
metaRep['biomass_reaction',regexpr('Pvalue',colnames(metaRep)) > 0]



tmpdataV = tmpdata[tmpdata$senType=='ROS',]
df2 <- data_summary(tmpdataV, varname="biomass_reaction", 
                    groupnames=c("ageType", "studyID"))

p<- ggplot(df2, aes(x=studyID, y=biomass_reaction, fill=ageType)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) + #geom_point(aes(group = ageType))+
  geom_errorbar(aes(ymin=biomass_reaction-sd, ymax=biomass_reaction+sd), width=.5,
                 position=position_dodge(.9)) +#+ #scale_color_aaas()+scale_fill_aaas()+
   labs(title="ROS-induced senescence", x="", y = "biomass_reaction(mmol/L/min)")+
   theme_classic() + scale_color_npg()+scale_fill_npg() + 
   lghplot.addtheme(size = 12,sizex =10,sizey = 10,hjust = T,legend.position = 'top')
pdf('./Figures/Figure1/Figure1E_biomass_ROS1.pdf',width = 3,height = 4)
 print(p)
dev.off()
metaROS['biomass_reaction',regexpr('Pvalue',colnames(metaROS)) > 0]

tmpdataV = tmpdata[tmpdata$senType=='IR',]
df2 <- data_summary(tmpdataV, varname="biomass_reaction", 
                    groupnames=c("ageType", "studyID"))

p<- ggplot(df2, aes(x=studyID, y=biomass_reaction, fill=ageType)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) + #geom_point(aes(group = ageType))+
  geom_errorbar(aes(ymin=biomass_reaction-sd, ymax=biomass_reaction+sd), width=.5,
                 position=position_dodge(.9)) +#+ #scale_color_aaas()+scale_fill_aaas()+
   labs(title="IRradiation-induced senescence", x="", y = "biomass_reaction(mmol/L/min)")+
   theme_classic() + scale_color_npg()+scale_fill_npg() + 
   lghplot.addtheme(size = 12,sizex =10,sizey = 10,hjust = T,legend.position = 'top')
pdf('./Figures/Figure1/Figure1F_biomass_IR1.pdf',width = 5,height = 4)
 print(p)
dev.off()
metaIR['biomass_reaction',regexpr('Pvalue',colnames(metaIR)) > 0]


tmpdataV = tmpdata[tmpdata$senType=='Onco',]
df2 <- data_summary(tmpdataV, varname="biomass_reaction", 
                    groupnames=c("ageType", "studyID"))

p<- ggplot(df2, aes(x=studyID, y=biomass_reaction, fill=ageType)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) + #geom_point(aes(group = ageType))+
  geom_errorbar(aes(ymin=biomass_reaction-sd, ymax=biomass_reaction+sd), width=.5,
                 position=position_dodge(.9)) +#+ #scale_color_aaas()+scale_fill_aaas()+
   labs(title="Oncogene-induced senescence", x="", y = "biomass_reaction(mmol/L/min)")+
   theme_classic() + scale_color_npg()+scale_fill_npg() + 
   lghplot.addtheme(size = 12,sizex =10,sizey = 10,hjust = T,legend.position = 'top')
pdf('./Figures/Figure1/Figure1G_biomass_Onco1.pdf',width = 4,height = 4)
 print(p)
dev.off()
metaOnco['biomass_reaction',regexpr('Pvalue',colnames(metaOnco)) > 0]

```

# 5. Figure 2 Flux meta_analysis

## 5.1 replication

```{r}
metaRep = metaflux(repFlux3vmax,repClin,meta.method = 'FEM')
writetxt(metaRep,'./results/Replication/replication_fluxes_meta_analysis.txt')
sum(metaRep$MetaFDR < 0.05)

tmpxx = metaRep[,1:6]
colnames(tmpxx) = gsub('Meta','',colnames(tmpxx))
tmpxx$Pvalue = tmpxx$FDR
tmpxx$Pvalue[is.na(tmpxx$Pvalue)] = 1
# plot valcano
pdf('./Figures/Figure2/Figure2A_vocano_rep.pdf')
p = plot_DEflux(tmpxx,xlab = bquote(~Log[2] ~ "fold change(median across 13 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'DEflux in replication senescence')
print(p)
dev.off()

compathway.rep = Flux.subsystem_WDA(tmpxx,annote = Recon3.annote[rownames(tmpxx),],
                                    pdffile = './Figures/Figure2/DAscore_rep.pdf')

```

```{r}
#plot pathway heatmap
DE.rep = list()
thenames = names(repFlux3vmax)
for(i in 1:length(thenames)){
  studyname = thenames[i]
  tmpdir = paste0('./results/Replication/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.rep[[i]] = tmpdascore
}
names(DE.rep) = thenames
DAscore.rep = str2num(list_element_select(DE.rep,as.vector(compathway.rep$subsystem),'DAscore'))
DAscore.rep[is.na(DAscore.rep)] = 0
DAFDR.rep = str2num(list_element_select(DE.rep,as.vector(compathway.rep$subsystem),'fdr'))
DAFDR.rep[is.na(DAFDR.rep)] = 1
#
display_matrix = matrix(' ',nrow(DAscore.rep),ncol(DAscore.rep))
display_matrix[DAFDR.rep < 0.1] = '.'
display_matrix[DAFDR.rep >= 0.01 & DAFDR.rep < 0.05] = '*'
display_matrix[DAFDR.rep >= 0.001 & DAFDR.rep < 0.01] = '**'
display_matrix[DAFDR.rep < 0.001] = '***'

enbrks<-c(-1,-0.8,-0.4,-0.2,-0.05,-0.02,0.02,0.05,0.2,0.4,0.8,1)
idx = abs(rowSums(sign(DAscore.rep),na.rm = T)) > ncol(DAscore.rep)/3

pheatmap::pheatmap(DAscore.rep[idx,],scale = 'none',cluster_rows = T,cluster_cols = T,fontsize_row = 9,fontsize_col = 9,
                       breaks = enbrks,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       display_numbers = display_matrix[idx,],
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./results/Replication/Figure_common_pathwayheatmap_ALL_filter.pdf',
                  height = 8,width = 7)


```

## 5.2 ROS

```{r}
metaROS = metaflux(ROSFlux3vmax,ROSClin,meta.method = 'FEM')
writetxt(metaROS,'./results/ROS/ROS_fluxes_meta_analysis.txt')
sum(metaROS$MetaFDR < 0.05)

tmpxx = metaROS[,1:6]
colnames(tmpxx) = gsub('Meta','',colnames(tmpxx))
tmpxx$Pvalue = tmpxx$FDR
tmpxx$Pvalue[is.na(tmpxx$Pvalue)] = 1
pdf('./Figures/Figure2/Figure2B_vocano_ROS.pdf')
plot_DEflux(tmpxx,xlab = bquote(~Log[2] ~ "fold change(median across 3 studies)"),num.showlab = 50,
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'DEflux in ROS-induced senescence')
dev.off()

compathway.ROS = Flux.subsystem_WDA(tmpxx,annote = Recon3.annote[rownames(tmpxx),],
                                    pdffile = './Figures/Figure2/DAscore_ROS.pdf')
```

```{r}
#plot pathway heatmap
DE.ROS = list()
thenames = names(ROSFlux3vmax)
for(i in 1:length(thenames)){
  studyname = thenames[i]
  tmpdir = paste0('./results/ROS/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.ROS[[i]] = tmpdascore
}
names(DE.ROS) = thenames
DAscore.ROS = str2num(list_element_select(DE.ROS,as.vector(compathway.ROS$subsystem),'DAscore'))
DAscore.ROS[is.na(DAscore.ROS)] = 0
DAFDR.ROS = str2num(list_element_select(DE.ROS,as.vector(compathway.ROS$subsystem),'fdr'))
DAFDR.ROS[is.na(DAFDR.ROS)] = 1
#
display_matrix = matrix(' ',nrow(DAscore.ROS),ncol(DAscore.ROS))
display_matrix[DAFDR.ROS < 0.1] = '.'
display_matrix[DAFDR.ROS >= 0.01 & DAFDR.ROS < 0.05] = '*'
display_matrix[DAFDR.ROS >= 0.001 & DAFDR.ROS < 0.01] = '**'
display_matrix[DAFDR.ROS < 0.001] = '***'

enbrks<-c(-1,-0.8,-0.4,-0.2,-0.05,-0.02,0.02,0.05,0.2,0.4,0.8,1)

idx = abs(rowSums(sign(DAscore.ROS),na.rm = T)) > ncol(DAscore.ROS)/3

pheatmap::pheatmap(DAscore.ROS[idx,],scale = 'none',cluster_rows = T,cluster_cols = T,fontsize_row = 9,fontsize_col = 9,
                       breaks = enbrks,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       display_numbers = display_matrix[idx,],
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./results/ROS/Figure_common_pathwayheatmap_ALL_filter.pdf',
                  height = 8,width = 7)


```

## 5.3 IR

```{r}
metaIR = metaflux(IRFlux3vmax,IRClin,meta.method = 'FEM')
writetxt(metaIR,'./results/IRradiation/IR_fluxes_meta_analysis.txt')
sum(metaIR$MetaFDR < 0.05)

tmpxx = metaIR[,1:6]
colnames(tmpxx) = gsub('Meta','',colnames(tmpxx))
tmpxx$Pvalue = tmpxx$FDR
tmpxx$Pvalue[is.na(tmpxx$Pvalue)] = 1

pdf('./Figures/Figure2/Figure2C_vocano_IR.pdf')
plot_DEflux(tmpxx,xlab = bquote(~Log[2] ~ "fold change(median across 9 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'DEflux in IRradiation-induced senescence')
dev.off()

compathway.IR = Flux.subsystem_WDA(tmpxx,annote = Recon3.annote[rownames(tmpxx),],
                                   pdffile = './Figures/Figure2/DAscore_IR.pdf')
```

```{r}
#plot pathway heatmap
DE.IR = list()
thenames = names(IRFlux3vmax)
for(i in 1:length(thenames)){
  studyname = thenames[i]
  tmpdir = paste0('./results/IRradiation/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.IR[[i]] = tmpdascore
}
names(DE.IR) = thenames
DAscore.IR = str2num(list_element_select(DE.IR,as.vector(compathway.IR$subsystem),'DAscore'))
DAscore.IR[is.na(DAscore.IR)] = 0
DAFDR.IR = str2num(list_element_select(DE.IR,as.vector(compathway.IR$subsystem),'fdr'))
DAFDR.IR[is.na(DAFDR.IR)] = 1
#
display_matrix = matrix(' ',nrow(DAscore.IR),ncol(DAscore.IR))
display_matrix[DAFDR.IR < 0.1] = '.'
display_matrix[DAFDR.IR >= 0.01 & DAFDR.IR < 0.05] = '*'
display_matrix[DAFDR.IR >= 0.001 & DAFDR.IR < 0.01] = '**'
display_matrix[DAFDR.IR < 0.001] = '***'
rownames(display_matrix) = rownames(DAFDR.IR)

enbrks<-c(-1,-0.8,-0.4,-0.2,-0.05,-0.02,0.02,0.05,0.2,0.4,0.8,1)
#idx = abs(rowSums(sign(DAscore.IR),na.rm = T)) > ncol(DAscore.IR)/3
idx = intersect(compathway.IR$subsystem,rownames(DAscore.IR))



pheatmap::pheatmap(DAscore.IR[idx,],scale = 'none',cluster_rows = T,cluster_cols = T,fontsize_row = 9,fontsize_col = 9,
                       breaks = enbrks,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       display_numbers = display_matrix[idx,],
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./results/IRradiation/Figure_common_pathwayheatmap_ALL1.pdf',
                  height = 8,width = 7)

```

## 5.4 Oncogene

```{r}
metaOnco = metaflux(OncoFlux3vmax,OncoClin,meta.method = 'FEM')
writetxt(metaOnco,'./results/Oncogene/Onco_fluxes_meta_analysis.txt')
sum(metaOnco$MetaFDR < 0.05)

tmpxx = metaOnco[,1:6]
colnames(tmpxx) = gsub('Meta','',colnames(tmpxx))
tmpxx$Pvalue = tmpxx$FDR
tmpxx$Pvalue[is.na(tmpxx$Pvalue)] = 1

pdf('./Figures/Figure2/Figure2D_vocano_Onco.pdf')
plot_DEflux(tmpxx,xlab = bquote(~Log[2] ~ "fold change(median across 4 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'DEflux in Oncogene-induced senescence')
dev.off()
compathway.Onco = Flux.subsystem_WDA(tmpxx,annote = Recon3.annote[rownames(tmpxx),],
                                     pdffile = './Figures/Figure2/DAscore_Onco.pdf')
```

```{r}
#plot pathway heatmap
DE.Onco = list()
thenames = names(OncoFlux3vmax)
for(i in 1:length(thenames)){
  studyname = thenames[i]
  tmpdir = paste0('./results/Oncogene/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.Onco[[i]] = tmpdascore
}
names(DE.Onco) = thenames
DAscore.Onco = str2num(list_element_select(DE.Onco,as.vector(compathway.Onco$subsystem),'DAscore'))
DAscore.Onco[is.na(DAscore.Onco)] = 0
DAFDR.Onco = str2num(list_element_select(DE.Onco,as.vector(compathway.Onco$subsystem),'fdr'))
DAFDR.Onco[is.na(DAFDR.Onco)] = 1
#
display_matrix = matrix(' ',nrow(DAscore.Onco),ncol(DAscore.Onco))
display_matrix[DAFDR.Onco < 0.1] = '.'
display_matrix[DAFDR.Onco >= 0.01 & DAFDR.Onco < 0.05] = '*'
display_matrix[DAFDR.Onco >= 0.001 & DAFDR.Onco < 0.01] = '**'
display_matrix[DAFDR.Onco < 0.001] = '***'

enbrks<-c(-1,-0.8,-0.4,-0.2,-0.05,-0.02,0.02,0.05,0.2,0.4,0.8,1)
#idx = abs(rowSums(sign(DAFDR.Onco),na.rm = T)) > ncol(DAFDR.Onco)/3

rownames(display_matrix) = rownames(DAFDR.Onco)
idx = intersect(compathway.Onco$subsystem,rownames(DAscore.Onco))

pheatmap::pheatmap(DAscore.Onco[idx,],scale = 'none',cluster_rows = T,cluster_cols = T,fontsize_row = 9,fontsize_col = 9,
                       breaks = enbrks,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       display_numbers = display_matrix[idx,],
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./results/Oncogene/Figure_common_pathwayheatmap_ALL_filter1.pdf',
                  height = 8,width = 7)
```

## 5.5 all DEflux, DAscore pca

```{r}
  shorten_names_forGO <- function(x, n_word=4, n_char=25){
    if (length(strsplit(x, " ")[[1]]) > n_word || (nchar(x) > n_char))
    {
      if (nchar(x) > n_char) x <- substr(x, 1, n_char)
      x <- paste(paste(strsplit(x, " ")[[1]][1:min(length(strsplit(x," ")[[1]]), n_word)],
                       collapse=" "), "...", sep="")
      return(x)
    }
    else
    {
      return(x)
    }
  }

  tlab=as.vector(sapply(rownames(DAscore.all),shorten_names_forGO))

```

```{r}
#venn
uprxns.Rep = metaRep$ID[metaRep$MetaFDR < 0.05 & metaRep$Metalog2FC > 0]
downrxns.Rep = metaRep$ID[metaRep$MetaFDR < 0.05 & metaRep$Metalog2FC < 0]
uprxns.ROS = metaROS$ID[metaROS$MetaFDR < 0.05 & metaROS$Metalog2FC > 0]
downrxns.ROS = metaROS$ID[metaROS$MetaFDR < 0.05 & metaROS$Metalog2FC < 0]
uprxns.IR = metaIR$ID[metaIR$MetaFDR < 0.05 & metaIR$Metalog2FC > 0]
downrxns.IR = metaIR$ID[metaIR$MetaFDR < 0.05 & metaIR$Metalog2FC > 0]
uprxns.Onco = metaOnco$ID[metaOnco$MetaFDR < 0.05 & metaOnco$Metalog2FC > 0]
downrxns.Onco = metaOnco$ID[metaOnco$MetaFDR < 0.05 & metaOnco$Metalog2FC < 0]
length(uprxns.Rep)
length(downrxns.Rep)
length(uprxns.ROS)
length(downrxns.ROS)
length(uprxns.IR)
length(downrxns.IR)
length(uprxns.Onco)
length(downrxns.Onco)

require(VennDiagram)
venn.diagram(list(Rep=uprxns.Rep,ROS = uprxns.ROS,
                  IR = uprxns.IR,Onco= uprxns.Onco), 
             #fill=c("red","blue",),
             fill = c("cornflowerblue", "green", "yellow", "darkorchid1"),
             alpha=c(0.5,0.5,0.5,0.5), cex=2, cat.fontface=3, cat.cex = 1.3,margin = 0.1,
             filename="./Figures/Figure2/Venn_DErxns_meta_up_rxns.tiff")

venn.diagram(list(Rep=downrxns.Rep,ROS = downrxns.ROS,
                  IR = downrxns.IR,Onco= downrxns.Onco), 
             #fill=c("red","blue",),
             fill = c("cornflowerblue", "green", "yellow", "darkorchid1"),
             alpha=c(0.5,0.5,0.5,0.5), cex=2, cat.fontface=3, cat.cex = 1.3,margin = 0.1,
             filename="./Figures/Figure2/Venn_DErxns_meta_down_rxns.tiff")
```

```{r}
# all DA heatmap
sentypes = c('rep','ROS','IR','Onco')
allDEcomp = list()
for(i in 1:length(sentypes)){
  tmp = get(paste0('compathway.',sentypes[i]))
  rownames(tmp) = tmp$subsystem
  allDEcomp[[i]] = tmp
}
all_DAids = unique(c(as.vector(compathway.rep$subsystem),
              as.vector(compathway.ROS$subsystem),
              as.vector(compathway.IR$subsystem),
              as.vector(compathway.Onco$subsystem)))
DAscore.all = str2num(list_element_select(allDEcomp,all_DAids,'WDAscore'))
DAscore.all[is.na(DAscore.all)] = 0
colnames(DAscore.all) = sentypes


cname = colnames(DAscore.all)
tclass = data.frame(senType = cname,row.names = cname)
idx = rowSums(abs(DAscore.all) > 0) > 1
all_common_DAids = rownames(DAscore.all)[idx]
tmp = DAscore.all
rownames(tmp) = as.vector(sapply(rownames(tmp),shorten_names_forGO))

pheatmap::pheatmap(tmp[idx,],scale = 'none',cluster_rows = T,cluster_cols = T,fontsize_row = 8,fontsize_col = 8,
                       breaks = enbrks,
                       annotation_col = tclass, 
                       treeheight_row = 6,treeheight_col = 6,legend = T,
                       #display_numbers = display_matrix,
                       cutree_col = 2,
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./Figures/Figure2/Figure2Ya_pathwayheatmap_metacentype.pdf',
                  height = 5,width = 3.5)


```

```{r}
#DAscore
sentypes = c('rep','ROS','IR','Onco')
DEall = list()
DEnames = c()
 k =0
for(i in 1:length(sentypes)){
  xclin = get(paste0(sentypes[i],'Clin'))
  thenames = names(xclin)
  for(j in 1:length(thenames)){
    studyname = thenames[j]
    tmpdir = paste0('./results/',sentypes[i],'/',studyname,'_vmax/WDA.cen.bootstrap.txt')
    tmpdascore = file2frame(tmpdir)
    rownames(tmpdascore) = tmpdascore$subsystem
    k = k+1
    DEall[[k]] = tmpdascore
    DEnames = c(DEnames,paste(sentypes[i],studyname,sep = '_'))
  }
}
names(DEall) = DEnames
DEall.clin = as.data.frame(strsplit2(DEnames,'_'))
colnames(DEall.clin) = c('sentype','celltype','study','batch')


all_DAids = unique(c(as.vector(compathway.rep$subsystem),
              as.vector(compathway.ROS$subsystem),
              as.vector(compathway.IR$subsystem),
              as.vector(compathway.Onco$subsystem)))
DEall.DAscore = str2num(list_element_select(DEall,all_DAids,'DAscore'))
DEall.DAscore[is.na(DEall.DAscore)] = 0
DEall.DAFDR = str2num(list_element_select(DEall,all_DAids,'fdr'))
DEall.DAFDR[is.na(DEall.DAFDR)] = 1

tpca = prcomp(t(DEall.DAscore),cor = F)
percPCA = 100*summary(tpca)$importance

tmpdata = data.frame(pc1 = tpca$x[,1],
                     pc2 = tpca$x[,2])
tmpdata = cbind(tmpdata,DEall.clin)
pdf('./Figures/Figure2/Figure2X_pca_DAscore.pdf',width = 8,height = 7)
ggplot(tmpdata,aes(pc1,pc2,color = sentype)) + #scale_color_aaas()+scale_fill_aaas()+
  geom_point(size = 5,aes(shape = sentype))+lghplot.addtheme(size = 20,legend.position = 'right')+
  xlab(paste("PC1(",as.character(round(percPCA[2,1],1)),'%)',sep = ''))+
  ylab(paste("PC2(",as.character(round(percPCA[2,2],1)),'%)',sep = ''))+
  ggtitle('Pathway enrichment PCA in different sen types')
dev.off()


display_matrix = matrix(' ',nrow(DEall.DAscore),ncol(DEall.DAscore))
display_matrix[DEall.DAFDR < 0.1] = '.'
display_matrix[DEall.DAFDR >= 0.01 & DEall.DAFDR < 0.05] = '*'
display_matrix[DEall.DAFDR >= 0.001 & DEall.DAFDR < 0.01] = '**'
display_matrix[DEall.DAFDR < 0.001] = '***'

enbrks<-c(-1,-0.8,-0.4,-0.2,-0.05,-0.02,0.02,0.05,0.2,0.4,0.8,1)

cname = colnames(DEall.DAscore)
tclass = data.frame(senType = DEall.clin$sentype,row.names = cname)
tmp = DEall.DAscore
rownames(tmp) = as.vector(sapply(rownames(tmp),shorten_names_forGO))

pheatmap::pheatmap(tmp,scale = 'none',cluster_rows = T,cluster_cols = T,fontsize_row = 9,fontsize_col = 9,
                       breaks = enbrks,
                       annotation_col = tclass, 
                       treeheight_row = 12,treeheight_col = 12,legend = T,
                       display_numbers = display_matrix,
                       cutree_col = 4,
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./Figures/Figure2/Figure2Y_pathwayheatmap_ALL.pdf',
                  height = 8,width = 8)

idx = rowSums(DEall.DAFDR < 0.05) > ncol(DEall.DAFDR)/4
pheatmap::pheatmap(DEall.DAscore[idx,],scale = 'none',cluster_rows = T,cluster_cols = T,fontsize_row = 9,fontsize_col = 9,
                       breaks = enbrks,
                       annotation_col = tclass, 
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       cutree_col = 3,
                       display_numbers = display_matrix[idx,],
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./Figures/Figure2/Figure2Y_pathwayheatmap_ALL_filter.pdf',
                  height = 8,width = 8)

```

```{r}
#DEflux
sentypes = c('rep','ROS','IR','Onco')
DEall_flux = list()
DEnames = c()
 k =0
for(i in 1:length(sentypes)){
  xclin = get(paste0(sentypes[i],'Clin'))
  thenames = names(xclin)
  for(j in 1:length(thenames)){
    studyname = thenames[j]
    tmpdir = paste0('./results/',sentypes[i],'/',studyname,'_vmax/DEflux.txt')
    tmpdascore = file2frame(tmpdir,)
    rownames(tmpdascore) = tmpdascore$ID
    k = k+1
    DEall_flux[[k]] = tmpdascore
    DEnames = c(DEnames,paste(sentypes[i],studyname,sep = '_'))
  }
}
names(DEall_flux) = DEnames
DEall_flux.clin = as.data.frame(strsplit2(DEnames,'_'))
colnames(DEall_flux.clin) = c('sentype','celltype','study','batch')



allidx = unique(c(metaRep$ID[metaRep$MetaFDR < 0.05],
           metaROS$ID[metaROS$MetaFDR < 0.05],
           metaIR$ID[metaIR$MetaFDR < 0.05],
           metaOnco$ID[metaOnco$MetaFDR < 0.05]))
           
           

#allidx = aamodel$rxns
#allidx = allidx[regexpr('Transport',aamodel$subSystems) < 0 
 #               &  regexpr('Exchange',aamodel$subSystems) <0 ]

DEall_flux.log2fc = str2num(list_element_select(DEall_flux,allidx,'log2FC'))
DEall_flux.log2fc[is.na(DEall_flux.log2fc)] = 0
DEall_flux.Pvalue = str2num(list_element_select(DEall_flux,allidx,'Pvalue'))
DEall_flux.Pvalue[is.na(DEall_flux.Pvalue)] = 1

tpca = prcomp(t(DEall_flux.log2fc),cor = F)
percPCA = 100*summary(tpca)$importance

tmpdata = data.frame(pc1 = tpca$x[,1],
                     pc2 = tpca$x[,2])
tmpdata = cbind(tmpdata,DEall_flux.clin)
pdf('./Figures/Figure2/Figure2X_pca_log2FC.pdf',width = 8,height = 7)
ggplot(tmpdata,aes(pc1,pc2,color = sentype)) + #scale_color_aaas()+scale_fill_aaas()+
  geom_point(size = 3,aes(shape = sentype))+lghplot.addtheme(size = 14,legend.position = 'right')+
  xlab(paste("PC1(",as.character(round(percPCA[2,1],1)),'%)',sep = ''))+
  ylab(paste("PC2(",as.character(round(percPCA[2,2],1)),'%)',sep = ''))+
  ggtitle('Overall log2FC enrichment in different cell types')
dev.off()

```

## 5.5 all meta

```{r}
#metaanalysis rep + ros

allflux3vamx = c(repFlux3vmax,ROSFlux3vmax)
allClin = c(repClin,ROSClin)
metaAll = metaflux(allflux3vamx,allClin,meta.method = 'FEM')
writetxt(metaAll,'./results/All_fluxes_meta_analysis.txt')
sum(metaAll$MetaFDR < 0.05)
sum(metaAll$MetaFDR < 0.05 & metaAll$MetaZvalue < 0)
sum(metaAll$MetaFDR < 0.05 & metaAll$MetaZvalue > 0)

intersect(metaRep$ID[metaRep$Metalog2FC > 0 & metaRep$MetaFDR < 0.05],
          metaROS$ID[metaROS$Metalog2FC > 0 & metaROS$MetaFDR < 0.05])
sum(metaROS$Metalog2FC > 0 & metaROS$MetaFDR < 0.05)

intersect(metaRep$ID[metaRep$Metalog2FC < 0 & metaRep$MetaFDR < 0.05],
          metaROS$ID[metaROS$Metalog2FC < 0 & metaROS$MetaFDR < 0.05])
sum(metaROS$Metalog2FC < 0 & metaROS$MetaFDR < 0.05)

tmpxx = metaAll[,1:6]
colnames(tmpxx) = gsub('Meta','',colnames(tmpxx))
tmpxx$Pvalue = tmpxx$FDR
tmpxx$Pvalue[is.na(tmpxx$Pvalue)] = 1
# plot valcano
pdf('./Figures/Figure2/Figure2X_vocano_ALL_rep_ROS.pdf')
p = plot_DEflux(tmpxx,xlab = bquote(~Log[2] ~ "fold change(median across 14 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'DEflux in replication senescence')
print(p)
dev.off()

tmpxx$log2FC = tmpxx$Zvalue
flux3.annote = Recon3.annote[rownames(tmpxx),]
# plot DAscore
compathway.repROS = Flux.subsystem_WDA(tmpxx,annote = flux3.annote,
                              pdffile = './Figures/Figure2/meta_analysis_DAscore_rep_ROS.pdf')



```

```{r}
#metaanalysis all
# repFlux
allflux3vamx = c(repFlux3vmax,ROSFlux3vmax,IRFlux3vmax,OncoFlux3vmax)
allClin = c(repClin,ROSClin,IRClin,OncoClin)
metaAll = metaflux(allflux3vamx,allClin,meta.method = 'FEM')
writetxt(metaAll,'./results/All_fluxes_meta_analysis.txt')
sum(metaAll$MetaFDR < 0.05)
sum(metaAll$MetaFDR < 0.05 & metaAll$MetaZvalue < 0)
sum(metaAll$MetaFDR < 0.05 & metaAll$MetaZvalue > 0)

tmpxx = metaAll[,1:6]
colnames(tmpxx) = gsub('Meta','',colnames(tmpxx))
tmpxx$Pvalue = tmpxx$FDR
tmpxx$Pvalue[is.na(tmpxx$Pvalue)] = 1
# plot valcano
pdf('./Figures/Figure2/Figure2X_vocano_ALL.pdf')
p = plot_DEflux(tmpxx,xlab = bquote(~Log[2] ~ "fold change(median across 27 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'DEflux in replication senescence')
print(p)
dev.off()

tmpxx$log2FC = tmpxx$Zvalue
flux3.annote = Recon3.annote[rownames(tmpxx),]
# plot DAscore
compathway.all = Flux.subsystem_WDA(tmpxx,annote = flux3.annote,
                              pdffile = './Figures/Figure2/meta_analysis_DAscore.pdf')




```

## 5.6 heatmap pathway all

```{r}
#rep + ROS
allcom_pathway = as.vector(compathway.repROS$subsystem)

DE.all = list()
thenamesRep = names(repFlux3vmax)
n = length(thenamesRep)
k = 0
for(i in 1:n){
  studyname = thenamesRep[i]
  tmpdir = paste0('./results/Replication/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.all[[i]] = tmpdascore
}
k = n+k

thenamesROS = names(ROSFlux3vmax)
n = length(thenamesROS)
for(i in (k+1):(k+n)){
  studyname = thenamesROS[i-k]
  tmpdir = paste0('./results/ROS/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.all[[i]] = tmpdascore
}
k = n+k



names(DE.all) = c(paste0('Rep_',thenamesRep),
                  paste0('ROS_',thenamesROS))

DAscore.all = str2num(list_element_select(DE.all,as.vector(allcom_pathway),'DAscore'))
DAscore.all[is.na(DAscore.all)] = 0
DAFDR.all = str2num(list_element_select(DE.all,as.vector(allcom_pathway),'fdr'))
DAFDR.all[is.na(DAFDR.all)] = 1
#
display_matrix = matrix(' ',nrow(DAscore.all),ncol(DAscore.all))
display_matrix[DAFDR.all < 0.1] = '.'
display_matrix[DAFDR.all >= 0.01 & DAFDR.all < 0.05] = '*'
display_matrix[DAFDR.all >= 0.001 & DAFDR.all < 0.01] = '**'
display_matrix[DAFDR.all < 0.001] = '***'

enbrks<-c(-1,-0.8,-0.4,-0.2,-0.05,-0.02,0.02,0.05,0.2,0.4,0.8,1)
DAscore.all_1 = DAscore.all
#DAscore.all_1[DAscore.all_1 == 0] = NA

cname = colnames(DAscore.all_1)
xx = regmatches(cname,regexpr('^[^_]+',cname))

tclass = data.frame(senType = xx,row.names = cname)
idx = abs(rowSums(sign(DAscore.all_1),na.rm = T)) > ncol(DAscore.all_1)/3

pheatmap::pheatmap(DAscore.all_1[idx,],scale = 'none',cluster_rows = T,cluster_cols = T,
                   fontsize_row = 9,fontsize_col = 9,
                   annotation_col = tclass, 
                       breaks = enbrks,
                       angle_col= 45,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       display_numbers = display_matrix[idx,],
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./Figures/Figure2/FigureE_common_pathwayheatmap_Rep_ROS_clusterCol_filter.pdf',
                  height = 8,width = 10)

```

```{r}

allcom_pathway = as.vector(compathway.all$subsystem)

DE.all = list()
thenamesRep = names(repFlux3vmax)
n = length(thenamesRep)
k = 0
for(i in 1:n){
  studyname = thenamesRep[i]
  tmpdir = paste0('./results/Replication/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.all[[i]] = tmpdascore
}
k = n+k

thenamesROS = names(ROSFlux3vmax)
n = length(thenamesROS)
for(i in (k+1):(k+n)){
  studyname = thenamesROS[i-k]
  tmpdir = paste0('./results/ROS/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.all[[i]] = tmpdascore
}
k = n+k

thenamesIR = names(IRFlux3vmax)
n = length(thenamesIR)
for(i in (k+1):(k+n)){
  studyname = thenamesIR[i-k]
  tmpdir = paste0('./results/IRradiation/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.all[[i]] = tmpdascore
}
k = n+k

thenamesOnco = names(OncoFlux3vmax)
n = length(thenamesOnco)
for(i in (k+1):(k+n)){
  studyname = thenamesOnco[i-k]
  tmpdir = paste0('./results/Oncogene/',studyname,'_vmax/WDA.cen.bootstrap.txt')
  tmpdascore = file2frame(tmpdir)
  rownames(tmpdascore) = tmpdascore$subsystem
  DE.all[[i]] = tmpdascore
}

names(DE.all) = c(paste0('Rep_',thenamesRep),
                  paste0('ROS_',thenamesROS),
                  paste0('IR_',thenamesIR),
                  paste0('Onco_',thenamesOnco))

DAscore.all = str2num(list_element_select(DE.all,as.vector(allcom_pathway),'DAscore'))
DAscore.all[is.na(DAscore.all)] = 0
DAFDR.all = str2num(list_element_select(DE.all,as.vector(allcom_pathway),'fdr'))
DAFDR.all[is.na(DAFDR.all)] = 1
#
display_matrix = matrix(' ',nrow(DAscore.all),ncol(DAscore.all))
display_matrix[DAFDR.all < 0.1] = '.'
display_matrix[DAFDR.all >= 0.01 & DAFDR.all < 0.05] = '*'
display_matrix[DAFDR.all >= 0.001 & DAFDR.all < 0.01] = '**'
display_matrix[DAFDR.all < 0.001] = '***'

enbrks<-c(-1,-0.8,-0.4,-0.2,-0.05,-0.02,0.02,0.05,0.2,0.4,0.8,1)
DAscore.all_1 = DAscore.all
DAscore.all_1[DAscore.all_1 == 0] = NA

cname = colnames(DAscore.all_1)
xx = regmatches(cname,regexpr('^[^_]+',cname))

tclass = data.frame(senType = xx,row.names = cname)
pheatmap::pheatmap(DAscore.all_1,scale = 'none',cluster_rows = T,cluster_cols = F,
                   fontsize_row = 9,fontsize_col = 9,
                   annotation_col = tclass, 
                       breaks = enbrks,
                       angle_col= 45,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       display_numbers = display_matrix,
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./Figures/Figure2/FigureE_common_pathwayheatmap_ALL_3_noclusterCol.pdf',
                  height = 8,width = 10)

```

# 6 Figure 3 Knock out genes analysis

## 6.1 get data

```{r}
#get KO gene data
tfiles = list.files(path = './results',pattern = 'keygenes.Rdata',full.names = T,recursive = T)
uname = tfiles
uname = gsub('_vmax','',uname)
uname = gsub('radiation','',uname)
uname = gsub('Replication','Rep',uname)
uname = gsub('Oncogene','Onco',uname)
xx = strsplit2(uname,'/')
thenames = paste(xx[,3],xx[,4],sep = '_')
KOgene = list()
for(i in 1:length(tfiles)){
  load(tfiles[i])
  tmp = keygenes$GeneEffects
  KOgene[[i]] = get_status_from_ko(tmp)
}
names(KOgene) = thenames
# use valid KOES
KOgene = KOgene[colnames(DAscore.all)]
KOgene.clin = as.data.frame(strsplit2(names(KOgene),'_'))
colnames(KOgene.clin) = c('senType','celltype','GEOID','batch')
rownames(KOgene.clin) = names(KOgene)

```

```{r}
plot_DEflux <- function (DEflux, pcutoff = 0.05, num.showlab = 10, alpha = 1,title = "DEflux", 
    xlab = bquote(~Log[2] ~ "fold change"), ylab = bquote(~-Log[10] ~ italic(P))) 
{
    res2 = DEflux
    keyvals <- rep("gray50", nrow(res2))
    names(keyvals) <- rep("NS", nrow(res2))
    keyvals[which(res2$log2FC > 0 & res2$Pvalue < pcutoff)] <- "Brown"
    names(keyvals)[which(res2$log2FC > 0 & res2$Pvalue < pcutoff)] <- "UP"
    keyvals[which(res2$log2FC < 0 & res2$Pvalue < pcutoff)] <- "darkblue"
    names(keyvals)[which(res2$log2FC < 0 & res2$Pvalue < pcutoff)] <- "Down"
    if (!is.element("ID", colnames(res2))) {
        res2$ID = rownames(res2)
    }
    thelab = res2$ID
    uptmp = res2[res2$log2FC > 0, ]
    downtmp = res2[res2$log2FC < 0, ]
    xid = sort.int(uptmp$Pvalue, decreasing = F, index.return = T)$ix
    uptmp = uptmp[xid, ]
    if (nrow(uptmp) > num.showlab) {
        uplab = uptmp$ID[1:num.showlab]
    }
    else {
        uplab = uptmp$ID
    }
    xid = sort.int(downtmp$Pvalue, decreasing = F, index.return = T)$ix
    downtmp = downtmp[xid, ]
    if (nrow(uptmp) > num.showlab) {
        downlab = downtmp$ID[1:num.showlab]
    }
    else {
        downlab = downtmp$ID
    }
    thelab[!is.element(thelab, c(uplab, downlab))] = NA
    p = EnhancedVolcano(res2, lab = thelab, x = "log2FC", y = "Pvalue",
                        xlim = c(min(res2$log2FC),max(res2$log2FC)),
        title = title, border = "full", titleLabSize = 18, FCcutoff = 0, 
        cutoffLineWidth = 0, cutoffLineType = "blank", axisLabSize = 18, 
        subtitle = NULL, cutoffLineCol = "white", gridlines.minor = F, 
        gridlines.major = F, xlab = xlab, ylab = ylab, pCutoff = pcutoff, 
        colCustom = keyvals, colAlpha = 4/5, legendPosition = "bottom", 
        legendLabSize = 12, legendIconSize = 3, drawConnectors = TRUE, 
        widthConnectors = 0.5, pointSize = -alpha*log10(res2$Pvalue), 
        labSize = 4, colConnectors = "black")
    return(p)
}
```

## 6.2 Figure 3A volcano rep geneKO

```{r}
#Figure 3A  valcano rep gene ko
idx = rownames(KOgene.clin)[KOgene.clin$senType == 'Rep']
tmplist = KOgene[idx]
KOES.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
KOPvalue.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'Pvalue'))
KOPvalue.rep[is.na(KOPvalue.rep)] =1
rownames(KOPvalue.rep) = toupper(rownames(KOPvalue.rep))
x<-list(p=KOPvalue.rep)
xx = MetaDE.pvalue(x = x,meta.method = 'AW') 
tmpdata = data.frame(ID = rownames(KOPvalue.rep),
                     log2FC = rowMeans(KOES.rep),
                     Pvalue = as.vector(xx$meta.analysis$FDR))
tmpdata$Pvalue[tmpdata$Pvalue < 1e-75] = 1e-75

pdf('./Figures/Figure3/Figure3A_gene_KO_vocano_rep.pdf')
p = plot_DEflux(tmpdata,alpha = 0.1,num.showlab = 30,xlab = bquote("Effective Score(mean across 11 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'Predict key genes in replication senescence')
print(p)
dev.off()


```

## 6.3 Figure 3B volcano IR geneKO

```{r}
#Figure 3B  valcano IR gene ko
idx = rownames(KOgene.clin)[KOgene.clin$senType == 'IR']
tmplist = KOgene[idx]
KOES.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
KOPvalue.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'Pvalue'))
KOPvalue.rep[is.na(KOPvalue.rep)] =1
rownames(KOPvalue.rep) = toupper(rownames(KOPvalue.rep))
x<-list(p=KOPvalue.rep)
xx = MetaDE.pvalue(x = x,meta.method = 'AW') 
tmpdata = data.frame(ID = rownames(KOPvalue.rep),
                     log2FC = rowMeans(KOES.rep),
                     Pvalue = as.vector(xx$meta.analysis$FDR))
tmpdata$Pvalue[tmpdata$Pvalue < 1e-75] = 1e-75

pdf('./Figures/Figure3/Figure3B_gene_KO_vocano_IR.pdf')
p = plot_DEflux(tmpdata,alpha = 0.1,num.showlab = 30,xlab = bquote("Effective Score(mean across 9 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'Predict key genes in IR-induced senescence')
print(p)
dev.off()
```

## 6.3 Figure 3S1 volcano ROS geneKO

```{r}
#Figure 3S1  valcano ROS gene ko
idx = rownames(KOgene.clin)[KOgene.clin$senType == 'ROS']
tmplist = KOgene[idx]
KOES.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
KOPvalue.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'Pvalue'))
KOPvalue.rep[is.na(KOPvalue.rep)] =1
rownames(KOPvalue.rep) = toupper(rownames(KOPvalue.rep))
x<-list(p=KOPvalue.rep)
xx = MetaDE.pvalue(x = x,meta.method = 'AW') 
tmpdata = data.frame(ID = rownames(KOPvalue.rep),
                     log2FC = rowMeans(KOES.rep),
                     Pvalue = as.vector(xx$meta.analysis$FDR))
tmpdata$Pvalue[tmpdata$Pvalue < 1e-75] = 1e-75

pdf('./Figures/Figure3/Figure3_S1_gene_KO_vocano_ROS.pdf')
p = plot_DEflux(tmpdata,alpha = 0.1,num.showlab = 30,xlab = bquote("Effective Score(mean across 3 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'Predict key genes in ROS-induced senescence')
print(p)
dev.off()
```

## 6.4 Figure 3S2 volcano Oncogene geneKO

```{r}
#Figure 3S2  valcano Onco gene ko
idx = rownames(KOgene.clin)[KOgene.clin$senType == 'Onco']
tmplist = KOgene[idx]
KOES.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
KOPvalue.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'Pvalue'))
KOPvalue.rep[is.na(KOPvalue.rep)] =1
rownames(KOPvalue.rep) = toupper(rownames(KOPvalue.rep))
x<-list(p=KOPvalue.rep)
xx = MetaDE.pvalue(x = x,meta.method = 'AW') 
tmpdata = data.frame(ID = rownames(KOPvalue.rep),
                     log2FC = rowMeans(KOES.rep),
                     Pvalue = as.vector(xx$meta.analysis$FDR))
tmpdata$Pvalue[tmpdata$Pvalue < 1e-75] = 1e-75

pdf('./Figures/Figure3/Figure3_S2_gene_KO_vocano_Oncogene.pdf')
p = plot_DEflux(tmpdata,alpha = 0.1,num.showlab = 30,xlab = bquote("Effective Score(mean across 4 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'Predict key genes in Oncogene-induced senescence')
print(p)
dev.off()
```

## 6.5 Figure 3C heatmap all genekO

```{r}
# Figure 3C heatmap
u_senType = c('Rep','ROS','IR','Onco')
for(i in 1:length(u_senType)){
  idx = rownames(KOgene.clin)[KOgene.clin$senType == u_senType[i]]
  tmplist = KOgene[idx]
  KOES.tmp = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
  KOES.tmp[is.na(KOES.tmp)] = 0
  KOFDR.tmp = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'FDR'))
  KOFDR.tmp[is.na(KOFDR.tmp)] = 1
  KOES.tmp[KOFDR.tmp > 0.05] = 0
  idx = rowSums(KOES.tmp != 0 ) > ncol(KOES.tmp)/3
  KOES.tmp = as.data.frame(KOES.tmp[idx,])
  rownames(KOES.tmp) = toupper(rownames(KOES.tmp))
  KOFDR.tmp = as.data.frame(KOFDR.tmp[idx,])
  rownames(KOFDR.tmp) = toupper(rownames(KOFDR.tmp))
  if (i == 1){
    KOES = KOES.tmp
    KOFDR = KOFDR.tmp
  }else{
    xx = union(rownames(KOES),rownames(KOES.tmp))
    KOES = cbind(KOES[xx,],KOES.tmp[xx,])
    KOFDR = cbind(KOFDR[xx,],KOFDR.tmp[xx,])
    rownames(KOES) = xx
    rownames(KOFDR) = xx
  }
}

KOES[is.na(KOES)] = 0
KOFDR[is.na(KOFDR)] = 1


display_matrix = matrix(' ',nrow(KOES),ncol(KOES))
display_matrix[KOFDR < 0.1] = '.'
display_matrix[KOFDR >= 0.01 & KOFDR < 0.05] = '*'
display_matrix[KOFDR >= 0.001 & KOFDR < 0.01] = '**'
display_matrix[KOFDR < 0.001] = '***'

#enbrks<-c(-10,-8,-4,-2,2,4,8,10)
enbrks<- (-20):(20)

cname = colnames(KOES)
xx = regmatches(cname,regexpr('^[^_]+',cname))

tclass = data.frame(senType = xx,row.names = cname)
idx = rowSums(abs(KOES) > 0 ) > ncol(KOES)/2
pheatmap::pheatmap(KOES[idx,],scale = 'none',cluster_rows = T,cluster_cols = F,
                   fontsize_row = 9,fontsize_col = 9,
                   annotation_col = tclass, 
                       breaks = enbrks,
                       angle_col= 45,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       display_numbers = display_matrix[idx,],
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(40),
                file ='./Figures/Figure3/Figure_common_KOgenes_heatmap_all.pdf',
                  height = 10,width = 10)



```

```{r}
#network matrix dataset
#tfiles = list.files(path = './results/Replication/',pattern = 'keygenes.Rdata',full.names = T,recursive = T)
metaflux = file2frame('./results/Replication/replication_fluxes_meta_analysis.txt')
idx = metaflux$MetaFDR < 0.05
metasigflux = data.frame(ID = metaflux$ID[idx],stringsAsFactors = F,
                         log2FC = metaflux$Metalog2FC[idx],
                         Pvalue = metaflux$MetaPvalue[idx],
                         FDR = as.vector(metaflux$MetaFDR[idx]))
load("./results/Replication//BJ_GSE56293_1_vmax/keygenes_for_figure4_network.Rdata")
rownames(keygenes$KOmatrix) = toupper(rownames(keygenes$KOmatrix))
mvapathway = c('HMGCR','FDFT1','PMVK','MVK','FDPS','MVD')
genekomatrix = keygenes$KOmatrix[mvapathway,metasigflux$ID]

sigdir = sign(metasigflux$log2FC)
genekomatrix = t(t(genekomatrix)*sigdir)
writetxt_forGPMM(t(genekomatrix),filename = './Figures/Figure4/keygenes_for_figure4_network.txt')

```

# 7 Figure 4 Knock out metabolites

## 7.1 get metKO data

```{r}
#get KO metebolist data
tfiles = list.files(path = './results',pattern = 'keymetabolites.Rdata',full.names = T,recursive = T)
uname = tfiles
uname = gsub('_vmax','',uname)
uname = gsub('radiation','',uname)
uname = gsub('Replication','Rep',uname)
uname = gsub('Oncogene','Onco',uname)
xx = strsplit2(uname,'/')
thenames = paste(xx[,3],xx[,4],sep = '_')
KOmet = list()
for(i in 1:length(tfiles)){
  load(tfiles[i])
  tmp = keymetabolites$MetEffects
  #KOmet[[i]] = get_status_from_ko(tmp)
    tmp = keymetabolites$MetEffects
  tmpkoxx = get_status_from_ko(tmp)
  tmpkoxx = get_consist_mets(tmpkoxx)
  #tmpkoxx = tmpkoxx[tmpkoxx$direct.v !=0,]
  #rownames(tmpkoxx) = tmpkoxx$met_name
  KOmet[[i]] = tmpkoxx
}
names(KOmet) = thenames
# use valid KOES
KOmet = KOmet[names(DEall)]
KOmet.clin = as.data.frame(strsplit2(names(KOmet),'_'))
colnames(KOmet.clin) = c('senType','celltype','GEOID','batch')
rownames(KOmet.clin) = names(KOmet)
```

## 7.2 Figure 4A rep metaboliteKO

```{r}
#Figure 4A  valcano rep met ko
idx = rownames(KOmet.clin)[KOmet.clin$senType == 'rep']
tmplist = KOmet[idx]
KOES.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
KOPvalue.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'FDR'))
KOPvalue.rep[is.na(KOPvalue.rep)] =1
x<-list(p=KOPvalue.rep)
xx = MetaDE.pvalue(x = x,meta.method = 'AW') 
tmpdata = data.frame(ID = rownames(KOPvalue.rep),
                     log2FC = rowMeans(KOES.rep),
                     Pvalue = as.vector(xx$meta.analysis$FDR))
sum(tmpdata$Pvalue < 0.05 & tmpdata$log2FC > 0)
sum(tmpdata$Pvalue < 0.05 & tmpdata$log2FC < 0)

tmpdata$Pvalue[tmpdata$Pvalue < 1e-75] = 1e-75
tmpname = gsub('\\[\\w\\]','',tmpdata$ID)
cofactor = c('co2','o2','h2o','h','pi','nh4','nh3','no','ppi')
idx = !is.element(tmpname,cofactor)
tmpdata = tmpdata[idx,]

pdf('./Figures/Figure4/Figure4A_met_KO_vocano_rep_fdr.pdf',width = 7,height = 5)
p = plot_DEflux(tmpdata,alpha = 0.1,num.showlab = 20,xlab = bquote("Effective Score(mean across 11 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'Predict key metabolites in replication senescence')
print(p)
dev.off()


```

## 7.3 Figure 4B IR metaboliteKO

```{r}
#Figure 4B  valcano IR met ko
idx = rownames(KOmet.clin)[KOmet.clin$senType == 'IR']
tmplist = KOmet[idx]
KOES.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
KOPvalue.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'Pvalue'))
KOPvalue.rep[is.na(KOPvalue.rep)] =1
x<-list(p=KOPvalue.rep)
xx = MetaDE.pvalue(x = x,meta.method = 'AW') 
tmpdata = data.frame(ID = rownames(KOPvalue.rep),
                     log2FC = rowMeans(KOES.rep),
                     Pvalue = as.vector(xx$meta.analysis$FDR))
tmpdata$Pvalue[tmpdata$Pvalue < 1e-75] = 1e-75
tmpname = gsub('\\[\\w\\]','',tmpdata$ID)
cofactor = c('co2','o2','h2o','h','pi','nh4','nh3','no','ppi')
idx = !is.element(tmpname,cofactor)
tmpdata = tmpdata[idx,]

pdf('./Figures/Figure4/Figure4B_met_KO_vocano_IR.pdf')
p = plot_DEflux(tmpdata,alpha = 0.1,num.showlab = 30,xlab = bquote("Effective Score(mean across 9 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'Predict key metabolites in IR-inducde senescence')
print(p)
dev.off()


```

## 7.4 Figure 4S1 ROS metKO

```{r}
#Figure 4S1  valcano ROS met ko
idx = rownames(KOmet.clin)[KOmet.clin$senType == 'ROS']
tmplist = KOmet[idx]
KOES.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
KOPvalue.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'FDR'))
KOPvalue.rep[is.na(KOPvalue.rep)] =1
x<-list(p=KOPvalue.rep)
xx = MetaDE.pvalue(x = x,meta.method = 'AW') 
tmpdata = data.frame(ID = rownames(KOPvalue.rep),
                     log2FC = rowMeans(KOES.rep),
                     Pvalue = as.vector(xx$meta.analysis$FDR))
tmpdata$Pvalue[tmpdata$Pvalue < 1e-75] = 1e-75
tmpname = gsub('\\[\\w\\]','',tmpdata$ID)
cofactor = c('co2','o2','h2o','h','pi','nh4','nh3','no','ppi')
idx = !is.element(tmpname,cofactor)
tmpdata = tmpdata[idx,]

sum(tmpdata$Pvalue < 0.05 & tmpdata$log2FC > 0)
sum(tmpdata$Pvalue < 0.05 & tmpdata$log2FC < 0)

pdf('./Figures/Figure4/Figure4S1_met_KO_vocano_ROS_FDR.pdf')
p = plot_DEflux(tmpdata,alpha = 0.1,num.showlab = 8,xlab = bquote("Effective Score(mean across 3 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'Predict key metabolites in ROS-inducde senescence')
print(p)
dev.off()



```

## 7.5 Figure 4S2 Oncogene metKO

```{r}
#Figure 4S2  valcano Oncogene met ko
idx = rownames(KOmet.clin)[KOmet.clin$senType == 'Onco']
tmplist = KOmet[idx]
KOES.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
KOPvalue.rep = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'Pvalue'))
KOPvalue.rep[is.na(KOPvalue.rep)] =1
x<-list(p=KOPvalue.rep)
xx = MetaDE.pvalue(x = x,meta.method = 'AW') 
tmpdata = data.frame(ID = rownames(KOPvalue.rep),
                     log2FC = rowMeans(KOES.rep),
                     Pvalue = as.vector(xx$meta.analysis$FDR))
tmpdata$Pvalue[tmpdata$Pvalue < 1e-75] = 1e-75
tmpname = gsub('\\[\\w\\]','',tmpdata$ID)
cofactor = c('co2','o2','h2o','h','pi','nh4','nh3','no','ppi')
idx = !is.element(tmpname,cofactor)
tmpdata = tmpdata[idx,]

pdf('./Figures/Figure4/Figure4S2_met_KO_vocano_Oncogene.pdf')
p = plot_DEflux(tmpdata,alpha = 0.1,num.showlab = 30,xlab = bquote("Effective Score(mean across 4 studies)"),
            ylab = bquote(~-Log[10] ~ italic('FDR(meta analysis)')),
            title = 'Predict key metabolites in oncogene-inducde senescence')
print(p)
dev.off()
```

## 7.6 Figure 4C heatmap all metKO

```{r}
# Figure 4 heatmap
u_senType = c('Rep','ROS','IR','Onco')
for(i in 1:length(u_senType)){
  idx = rownames(KOmet.clin)[KOmet.clin$senType == u_senType[i]]
  tmplist = KOmet[idx]
  KOES.tmp = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'ES'))
  KOES.tmp[is.na(KOES.tmp)] = 0
  KOFDR.tmp = str2num(list_element_select(tmplist,rownames(tmplist[[1]]),'FDR'))
  KOFDR.tmp[is.na(KOFDR.tmp)] = 1
  KOES.tmp[KOFDR.tmp > 0.05] = 0
  idx = rowSums(KOES.tmp != 0 ) > ncol(KOES.tmp)/3
  KOES.tmp = as.data.frame(KOES.tmp[idx,])
 # rownames(KOES.tmp) = toupper(rownames(KOES.tmp))
  KOFDR.tmp = as.data.frame(KOFDR.tmp[idx,])
  if (i == 1){
    KOES = KOES.tmp
    KOFDR = KOFDR.tmp
  }else{
    xx = union(rownames(KOES),rownames(KOES.tmp))
    KOES = cbind(KOES[xx,],KOES.tmp[xx,])
    KOFDR = cbind(KOFDR[xx,],KOFDR.tmp[xx,])
    rownames(KOES) = xx
    rownames(KOFDR) = xx
  }
}

KOES[is.na(KOES)] = 0
KOFDR[is.na(KOFDR)] = 1

tmpname = gsub('\\[\\w\\]','',rownames(KOES))
cofactor = c('co2','o2','h2o','h','pi','nh4','nh3','no','ppi')
idx = !is.element(tmpname,cofactor) & rowSums(abs(KOES) > 0 ) > ncol(KOES)/2
KOES = KOES[idx,]
KOFDR  = KOFDR[idx,]

# get consist mets
tmpdata  = data.frame(ID = rownames(KOES),
                      ES = rowMeans(KOES),
                      FDR = apply(KOFDR,1,min))
tmpdata = get_consist_mets(tmpdata)
idx = tmpdata$direct.v != 0
KOES = KOES[idx,]
KOFDR = KOFDR[idx,]


display_matrix = matrix(' ',nrow(KOES),ncol(KOES))
display_matrix[KOFDR < 0.1] = '.'
display_matrix[KOFDR >= 0.01 & KOFDR < 0.05] = '*'
display_matrix[KOFDR >= 0.001 & KOFDR < 0.01] = '**'
display_matrix[KOFDR < 0.001] = '***'

#enbrks<-c(-10,-8,-4,-2,2,4,8,10)
enbrks<- (-20):(20)

cname = colnames(KOES)
xx = regmatches(cname,regexpr('^[^_]+',cname))

tclass = data.frame(senType = xx,row.names = cname)
common_keymets = rownames(KOES)


pheatmap::pheatmap(KOES,scale = 'none',cluster_rows = T,cluster_cols = F,
                   fontsize_row = 9,fontsize_col = 9,
                   annotation_col = tclass, 
                       breaks = enbrks,
                       angle_col= 45,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                       display_numbers = display_matrix,
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(40),
                file ='./Figures/Figure4/Figure_common_KOmets_heatmap_all_2.pdf',
                  height = 6,width = 8)
```

```{r}
#network matrix dataset
metaflux = file2frame('./results/Replication/replication_fluxes_meta_analysis.txt')
idx = metaflux$MetaFDR < 0.05
metasigflux = data.frame(ID = metaflux$ID[idx],stringsAsFactors = F,
                         log2FC = metaflux$Metalog2FC[idx],
                         Pvalue = metaflux$MetaPvalue[idx],
                         FDR = as.vector(metaflux$MetaFDR[idx]))
load("./results/Replication//BJ_GSE56293_1_vmax/keymetabolites_for_figure4_network.Rdata")
#rownames(keymetabolites$KOmatrix) = toupper(rownames(keygenes$KOmatrix))
mvapathway = common_keymets
metkomatrix = keymetabolites$KOmatrix[mvapathway,metasigflux$ID]

sigdir = sign(metasigflux$log2FC)
metkomatrix = t(t(metkomatrix)*sigdir)
writetxt_forGPMM(t(metkomatrix),filename = './Figures/Figure4/keymetabolites_for_figure4_network.txt')

```

# 8 Figure 5 time series HDF

## 8.1 load data

```{r}
HDFdataLM = loadRData('./results/HDF/Flux3_HDF_lm_bootstrp_vmax.Rdata')
HDFdataKO = loadRData('./results/HDF/HDF_key_genes_mets_rGPMM_vmax.Rdata')
dim(HDFdataLM$flux3)
```

```{r}
#network matrix dataset
#tfiles = list.files(path = './results/Replication/',pattern = 'keygenes.Rdata',full.names = T,recursive = T)
metaflux = file2frame('./results/Replication/replication_fluxes_meta_analysis.txt')
idx = metaflux$MetaFDR < 0.05
metasigflux = data.frame(ID = metaflux$ID[idx],stringsAsFactors = F,
                         log2FC = metaflux$Metalog2FC[idx],
                         Pvalue = metaflux$MetaPvalue[idx],
                         FDR = as.vector(metaflux$MetaFDR[idx]))
load("./results/Replication//BJ_GSE56293_1_vmax/keygenes_for_figure4_network.Rdata")
rownames(keygenes$KOmatrix) = toupper(rownames(keygenes$KOmatrix))
mvapathway = c('HMGCR','FDFT1','PMVK','MVK','FDPS','MVD')
genekomatrix = keygenes$KOmatrix[mvapathway,metasigflux$ID]

sigdir = sign(metasigflux$log2FC)
genekomatrix = t(t(genekomatrix)*sigdir)
writetxt_forGPMM(t(genekomatrix),filename = './Figures/Figure4/keygenes_for_figure4_network.txt')
```

## 8.2 Figur5A biomass_plot

```{r}
tmpdata = HDFdataLM$clin
tmpdata$biomass_reaction = HDFdataLM$flux3['biomass_reaction',]
#tmpdata$studyID = paste(tmpdata$senType,tmpdata$studyID,sep = '_')

data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}


df2 <- data_summary(tmpdata, varname="biomass_reaction", 
                    groupnames=c("age"))
df2
pd <- position_dodge(0.1) 
pdf('./Figures/Figure5/HDF_biomass_reaction.pdf',width = 7,height = 5)
ggplot(df2, aes(x=age, y=biomass_reaction)) + 
    theme_bw()+ geom_smooth(method = 'lm',size =1.5,color = '#4DBBD5FF')+
    geom_point(position=pd, size=4,color = '#E64B35FF')+
      geom_errorbar(aes(ymin=biomass_reaction-sd, ymax=biomass_reaction+sd), 
                  colour="#E64B35FF",
                  width=.1, position=pd)+
    lghplot.addtheme()+
    scale_x_continuous(breaks=seq(10,40,5))+
    ggtitle('HDF biomass_reaction')+
    xlab('Passages') +
    ylab('Biomass_reaction flux(mmol/L/min)')
dev.off()
cor.test(df2$biomass_reaction,df2$age)
```

## 8.3 oneline flux

```{r}
#one_line
HDFdataLM$lmflux$ID = HDFdataLM$lmflux$rxn
HDFdataLM$lmflux$log2FC = HDFdataLM$lmflux$beta.age
HDFdataLM$lmflux$Pvalue = HDFdataLM$lmflux$p.age
WDA.bootstrap = one_line_flux_analysis_from_bootstrap(HDFdataLM$flux3, HDFdataLM$flux3.log2,
                 HDFdataLM$flux3.annote,HDFdataLM$lmflux,HDFdataLM$bootstrapLmflux3,
                 './results/HDF/HDF_vmax',
                 pcutoff = 0.05, xlab = 'Replication effect (beta lm)')
```

## 8.4 flux trajactory

```{r}
metaflux = file2frame('./results/Replication/replication_fluxes_meta_analysis.txt')
idx = metaflux$MetaFDR < 0.05
metasigflux = data.frame(ID = metaflux$ID[idx],stringsAsFactors = F,
                         log2FC = metaflux$Metalog2FC[idx],
                         Pvalue = metaflux$MetaPvalue[idx],
                         FDR = as.vector(metaflux$MetaFDR[idx]))
HDFflux3.log2 = HDFdataLM$flux3.log2
HDFclin = HDFdataLM$clin
HDFflux3.log2.mean = t(aggregate(t(HDFflux3.log2),by=list(HDFclin$age),FUN=mean,na.rm = T ))
HDFflux3.log2.mean = HDFflux3.log2.mean[-1,]
colnames(HDFflux3.log2.mean) = paste0('p',unique(HDFclin$age))
HDFclin.mean = data.frame(ID = colnames(HDFflux3.log2.mean),
                          age = unique(HDFclin$age))
rownames(HDFclin.mean) = colnames(HDFflux3.log2.mean)

# venn
require(VennDiagram)
uprxns.meta = metasigflux$ID[metasigflux$FDR < 0.05 & metasigflux$log2FC > 0]
downrxns.meta = metasigflux$ID[metasigflux$FDR < 0.05 & metasigflux$log2FC < 0]
uprxns.HDF = HDFdataLM$lmflux$rxn[HDFdataLM$lmflux$p.age < 0.05 & HDFdataLM$lmflux$beta.age > 0]
downrxns.HDF = HDFdataLM$lmflux$rxn[HDFdataLM$lmflux$p.age < 0.05 & HDFdataLM$lmflux$beta.age < 0]
venn.diagram(list(uprxns_meta=uprxns.meta,downrxns_meta = downrxns.meta,
                  uprxns.time = uprxns.HDF,downrxns.time=downrxns.HDF), 
             #fill=c("red","blue",),
             fill = c("cornflowerblue", "green", "yellow", "darkorchid1"),
             alpha=c(0.5,0.5,0.5,0.5), cex=2, cat.fontface=3, cat.cex = 1.3,margin = 0.1,
             filename="./Figures/Figure5/Venn_rxns_meta_time.tiff")





idx= intersect(HDFdataLM$lmflux$rxn[HDFdataLM$lmflux$p.age < 0.05],metasigflux$ID)


#tclass = data.frame(passage = xx,row.names = cname)
pheatmap::pheatmap(HDFflux3.log2.mean[idx,],scale = 'row',cluster_rows = T,cluster_cols = F,
                   fontsize_row = 6,fontsize_col = 9,
                   #annotation_col = tclass, 
                       angle_col= 45,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(11),
                file ='./Figures/Figure5/FigureD_trajactory_heatmap.pdf',
                  height = 12,width = 4)


```

```{r}
standardise_matrix <- function (m) 
{
    out = m
    for (i in 1:nrow(m)) {
        #data[i, ] <- (data[i, ] - data[i, 1])/sd(data[i,], na.rm = TRUE)
        out[i, ] <- (m[i, ] -m[i, 1])/sd(m[i,], na.rm = TRUE)
    }
    out = out[-1,]
    return(out)
}
#trajactory
idx= intersect(HDFdataLM$lmflux$rxn[HDFdataLM$lmflux$p.age < 0.05],metasigflux$ID)
tmplm = HDFdataLM$lmflux[idx,]
cx =c('Cholesterol metabolism','Purine synthesis','Glycerophospholipid metabolism',
      'Sphingolipid metabolism','Pyrimidine synthesis','Triacylglycerol synthesis',
      'Fatty acid oxidation')
vrxnsIDs = tmplm$rxn[is.element(tmplm$subSystemes,cx)]
tmpflux.log2 = HDFflux3.log2.mean[vrxnsIDs,]
tmpflux.log2.z = standardise_matrix(tmpflux.log2)
subsystem = tmplm[rownames(tmpflux.log2.z),]$subSystemes
tmpdata = data.frame( flux = as.vector(tmpflux.log2.z),stringsAsFactors = F,
                      age = rep(HDFclin.mean$age,each = nrow(tmpflux.log2.z)),
                     rxns = rep(rownames(tmpflux.log2.z),times = ncol(tmpflux.log2.z)),
                     subsystem = rep(subsystem,times = ncol(tmpflux.log2.z))
                     )
pdf('./Figures/Figure5/Figure5F_Trajactory of subsystem.pdf',width = 6,height = 6)
p = ggplot(tmpdata,aes(age,flux,group = subsystem,color = subsystem))+ scale_color_npg()+
      scale_fill_npg()+
      geom_smooth(method = 'loess',se = F,size = 2, alpha = 1)+ theme_bw()+
      lghplot.addtheme(size = 12,sizex = 12,sizey = 12,legend.position = 'bottom')+
      scale_x_continuous(breaks=seq(10,40,5))+
      ggtitle('Trajactory of subsystem')+
      xlab('Passages') +
      ylab('Z-value of log2(fluxes)')
print(p)
dev.off()
print(p)

```

## 8.5 ko analysis

```{r}
HDFgeneko = get_status_from_ko(HDFdataKO$keygenes$GeneEffects)
HDFgeneko$ID = toupper(HDFgeneko$ID)
HDFgeneko$Pvalue = HDFgeneko$FDR
HDFgeneko$log2FC = HDFgeneko$ES
HDFgeneko$Pvalue[HDFgeneko$Pvalue < 1e-32] = 1e-32
pdf('./Figures/Figure5/FigureG_kogene.pdf')
plot_DEflux(HDFgeneko,num.showlab = 15,xlab = bquote(~Log[2] ~ "Effective Score"), alpha = 0.3,
            ylab = bquote(~-Log[10] ~ italic(FDR)),title = 'Predicted HDF senescence Key genes')
dev.off()

```

```{r}
HDFmetko = get_status_from_ko(HDFdataKO$keymetabolites$MetEffects)
HDFmetko = get_consist_mets(HDFmetko)
HDFmetko$Pvalue = HDFmetko$FDR
HDFmetko$log2FC = HDFmetko$ES
indx = sort.int(HDFmetko$FDR,decreasing = F,index.return = T)$ix
HDFmetko  =HDFmetko[indx,]
HDFmetko$Pvalue[HDFmetko$Pvalue < 1e-32] = 1e-32
idx = duplicated(HDFmetko$met_name)
#idx = HDFmetko$direct!=0 & HDFmetko$direct.v == 0 
HDFmetko = HDFmetko[!idx,]
cofactor = c('co2','o2','h2o','h','pi','nh4','nh3','no','ppi')
idx = !is.element(HDFmetko$met_name,cofactor)
HDFmetko = HDFmetko[idx,]
#HDFmetko$ID = HDFmetko$met_name

pdf('./Figures/Figure5/FigureH_komet.pdf')
plot_DEflux(HDFmetko,num.showlab = 100,xlab = bquote(~Log[2] ~ "Effective Score"), alpha = 0.1,
            ylab = bquote(~-Log[10] ~ italic(FDR)),title = 'Predicted HDF senescence Key metabolites')
dev.off()
```

## 8.6 metabolism

```{r}
met_pos = as.data.frame(readxl::read_xlsx('./data/HDF_metabolism/RTBXB-POS.xlsx'))
met_pos$MS2.score[is.na(met_pos$MS2.score)] = 0
met_pos = met_pos[met_pos$MS2.score > 0.6,]
rownames(met_pos) = paste0('met_pos',1:nrow(met_pos))

met_neg = as.data.frame(readxl::read_xlsx('./data/HDF_metabolism/RTBXB-NEG.xlsx'))
met_neg$MS2.score[is.na(met_neg$MS2.score)] = 0
met_neg = met_neg[met_neg$MS2.score > 0.6,]
rownames(met_neg) = paste0('met_neg',1:nrow(met_neg))
mets = rbind(met_pos,met_neg)

mets.header = mets[,1:14]
mets.num = as.matrix(mets[,substr(colnames(mets),4,6) == '_M_'])
mets.num = log2(fillgaps_rowMin(mets.num))
idbb = CVs(mets.num) > 1e-3  & !is.infinite(rowSums(mets.num))
#idbb[is.na(idbb)] == FALSE
mets.header = mets.header[idbb,]
mets.num = mets.num[idbb,]

clin = data.frame(age = as.numeric(substr(colnames(mets.num),2,3)))


lmmet = data.frame(ID = rownames(mets.num),stringsAsFactors = F,
                    meanexpr = rowMeans(mets.num),
                    beta.age = rep(0,nrow(mets.num)),
                    p.age = rep(1,nrow(mets.num)))


for (i in 1:nrow(mets.num)){
    bx = lm(mets.num[i,] ~ clin$age)
    lmmet$beta.age[i] = bx$coefficients[2]
    lmmet$p.age[i] = car::Anova(bx)$`Pr(>F)`[1] 
}
lmmet$fdr.age = p.adjust(lmmet$p.age,method = 'fdr')
rownames(lmmet) = rownames(mets.num)
lmmet =cbind(lmmet,mets.header)
writetxt_forGPMM(lmmet,'./results/HDF/lm_metabolism.txt')

lmmet$Pvalue = lmmet$fdr.age
lmmet$log2FC = lmmet$beta.age
mets.header$subSystemes = mets.header$SuperClass
# 
enrichup = Flux.subsystem_enrichment(lmmet,mets.header,direct = 'UP')
writetxt_forGPMM(enrichup,'results/HDF/enrichment_metabolism_up.txt')
enrichdown = Flux.subsystem_enrichment(lmmet,mets.header,direct = 'DOWN')
writetxt_forGPMM(enrichdown,'results/HDF/enrichment_metabolism_down.txt')
```

```{r}
# lipid
met_pos = file2frame('./data/HDF_metabolism/final_lipid_POS.csv',sep = ',')
met_pos$MS2.score[is.na(met_pos$MS2.score)] = 0
met_pos = met_pos[met_pos$MS2.score > 0.6,]
rownames(met_pos) = paste0('met_pos',1:nrow(met_pos))

met_neg = file2frame('./data/HDF_metabolism/final_lipid_neg.csv',sep = ',')
met_neg$MS2.score[is.na(met_neg$MS2.score)] = 0
met_neg = met_neg[met_neg$MS2.score > 0.6,]
rownames(met_neg) = paste0('met_neg',1:nrow(met_neg))
mets = rbind(met_pos,met_neg)

mets.header = mets[,1:8]
mets.num = as.matrix(mets[,substr(colnames(mets),4,6) == '_M_'])
mets.num = log2(fillgaps_rowMin(mets.num))
idbb = CVs(mets.num) > 1e-3  & !is.infinite(rowSums(mets.num))
#idbb[is.na(idbb)] == FALSE
mets.header = mets.header[idbb,]
mets.num = mets.num[idbb,]

clin = data.frame(age = as.numeric(substr(colnames(mets.num),2,3)))


lmmet = data.frame(ID = rownames(mets.num),stringsAsFactors = F,
                    meanexpr = rowMeans(mets.num),
                    beta.age = rep(0,nrow(mets.num)),
                    p.age = rep(1,nrow(mets.num)))


for (i in 1:nrow(mets.num)){
    bx = lm(mets.num[i,] ~ clin$age)
    lmmet$beta.age[i] = bx$coefficients[2]
    lmmet$p.age[i] = car::Anova(bx)$`Pr(>F)`[1] 
}
lmmet$fdr.age = p.adjust(lmmet$p.age,method = 'fdr')
rownames(lmmet) = rownames(mets.num)
lmmet =cbind(lmmet,mets.header)
writetxt_forGPMM(lmmet,'./results/HDF/lm_metabolism_lipid.txt')

lmmet$Pvalue = lmmet$fdr.age
lmmet$ID = lmmet$MS2.name
lmmet$log2FC = lmmet$beta.age
# 
idx = lmmet$fdr.age < 0.05
lmmet.v = lmmet[idx,]
lmmet.v$tcolor = lmmet.v$beta.age > 0
idx = sort.int(lmmet.v$beta.age,decreasing = F,index.return = T)$ix
lmmet.v= lmmet.v[idx,]
lmmet.v$MS2.name = factor(lmmet.v$MS2.name,levels = lmmet.v$MS2.name)
pdf('./Figures/Figure5/DE_metabolism_lipid.pdf',width = 13,height = 7)
ggplot(lmmet.v,aes(x=MS2.name,y = beta.age)) +
  geom_bar(aes(fill = tcolor),position=position_dodge(0.8),color = 'gray10',stat = 'identity')+
  scale_fill_manual(values = c('#4DBBD5FF','#E64B35FF'))+xlab('') + ylab('beta lm (FDR < 0.05)')+  lghplot.addtheme(size = 16,sizex = 12,sizey = 16,hjust = T)
dev.off()
```

# 9 Figure 6 c elegans validation

## 9.1 DE expression

```{r}
HDFexpr = file2frame('E:/github/code_forpublication/Cen_M1M3_metabolism/data/C_elgans_from_zqq/M1-M6quant/fpkm_m6.txt',row.names =1)
#HDFexpr  = log2(HDFexpr+1e-3)
idx = substr(colnames(HDFexpr),1,2) =='N2' | substr(colnames(HDFexpr),1,2) =='M6'
HDFexpr = HDFexpr[,idx]

DEexpr = DEGenes.simplified(HDFexpr,catagory = substr(colnames(HDFexpr),1,2) =='M6')
#DEexpr$Pvalue = DEexpr$FDR
tmp = DEexpr
tmp$Pvalue = DEexpr$FDR
pdf('./Figures/Figure6/Figure6H_FDR_fpkm.pdf')
plot_DEflux(DEexpr,alpha = 0.3,FCcutoff = 0.58,title = 'DEgene after mev administration',
            ylab = bquote(~-Log[10] ~ italic(FDR)))
dev.off()

sum(DEexpr$FDR < 0.05 & DEexpr$log2FC > 0.58)
sum(DEexpr$FDR < 0.05 & DEexpr$log2FC < -0.58)

writetxt(DEexpr$ID[DEexpr$FDR < 0.05 & DEexpr$log2FC > 0.58],'./Figures/Figure6/mev_upgenes.txt')
writetxt(DEexpr$ID[DEexpr$FDR < 0.05 & DEexpr$log2FC < -0.58],'./Figures/Figure6/mev_downgenes.txt')
```

## 8.6 fgsea analysis

```{r}
library(fgsea)
library(msigdbr)
pathwaysDF <- msigdbr("Caenorhabditis elegans",category = "C2", subcategory = "CP:KEGG")
pathways <- split(as.character(pathwaysDF$ensembl_gene), pathwaysDF$gs_name)

tfc.mev = DEexpr$log2FC
names(tfc.mev) = DEexpr$ID
tfc.mev = sort(tfc.mev,decreasing = F)

fgseaRes <- fgsea(pathways = pathways, 
                  stats    = tfc.mev,
                  eps      = 0.0,
                  minSize  = 15,
                  maxSize  = 500)

topPathwaysUp <- fgseaRes[ES > 0][head(order(pval), n=20), pathway]
topPathwaysDown <- fgseaRes[ES < 0][head(order(pval), n=20), pathway]
topPathways <- c(topPathwaysUp, rev(topPathwaysDown))
p = plotGseaTable(pathways[topPathways], tfc.mev, fgseaRes, 
              gseaParam=0.5,)
pdf(file = './Figures/Figure6/GSEA_CP_KEGG_fpkm.pdf',width = 10,height = 12)
print(p)
dev.off()
tmpaa = as.data.frame(fgseaRes)
tmpaa$log2FC = tmpaa$NES
tmpaa$Pvalue = tmpaa$padj
tmpaa$ID = gsub('KEGG_','',tmpaa$pathway)
rownames(tmpaa) = tmpaa$ID
pdf('./Figures/Figure6/gsea_kegg_plot_fpkm.pdf',width = 12,height = 12)
plot_DEflux(tmpaa,num.showlab = 15,title = 'KEGG GSEA analysis', 
            ylab = bquote(~-Log[10] ~ italic(FDR)),
            xlab = 'NES')
dev.off()

```

```{r}
pdf(file = './Figures/Figure6/GSEA_KEGG_fatty_acid_metabolism_fpkm.pdf')
plotEnrichment(pathways[["KEGG_FATTY_ACID_METABOLISM"]],
               tfc.mev) + labs(title="KEGG_FATTY_ACID_METABOLISM")
dev.off()
```

```{r}
xx = pathways[["KEGG_FATTY_ACID_METABOLISM"]]
xx = intersect(rownames(HDFexpr),xx)
tmpdata = HDFexpr[xx,]
colnames(tmpdata)=c('MEV_1','MEV_2','MEV_3','N2_1','N2_2','N2_3')
idx = DEexpr[xx,]$FDR < 0.05
tclass = data.frame(Type = factor(c('MEV','MEV','MEV','N2','N2','N2'),levels = c('N2','MEV')),
                    row.names = colnames(tmpdata)) 
pheatmap::pheatmap(tmpdata[idx,],scale = 'row',cluster_rows = T,cluster_cols = T,
                   fontsize_row = 9,fontsize_col = 9,
                   annotation_col = tclass, 
                       #breaks = enbrks,
                       angle_col= 45,
                       treeheight_row = 20,treeheight_col = 20,legend = T,
                  #color=colorRampPalette(c('#3B4992','gray95','#BB0021'))(9),
                       #colorRampPalette(c('#008280','gray95','#BB0021'))(11),
                color=colorRampPalette(c('#4DBBD5FF','gray95','#E64B35FF'))(40),
                file ='./Figures/Figure6/Fatty acid metabolism_heatmap_fpkm.pdf',
                  height = 6,width = 6)
```

```{r}
#Recon3_subsystem
gmtRecon3 = file2frame('./Figures/Figure6/Recon3D301_subsystem.gmt',header = F)
allgenes = paste0(gmtRecon3$V2,collapse = ',')
allgenes = unique(strsplit(allgenes,split = ',')[[1]])
writetxt(allgenes,'./Figures/Figure6/allRecon3genes.txt')

# orth from "https://www.flyrnai.org/cgi-bin/DRSC_orthologs_v08.pl" high vs high
orth = file2frame('./Figures/Figure6/ortholg_human_c_elegans_recon3.txt')
tmppathways = list()
for(i in 1:nrow(gmtRecon3)){
  xx = unique(strsplit(gmtRecon3$V2[i],split = ',')[[1]])
  idx = is.element(orth$Search.Term,xx)
  tmppathways[[i]] = unique(orth$Worm.Species.Gene.ID[idx])
}
names(tmppathways) = gmtRecon3$V1
```

# 10. possible mechanism

```{r}
metageneRep = metaGene(repExpr,repClin,meta.method = 'FEM')
metageneROS = metaGene(ROSExpr,ROSClin,meta.method = 'FEM')
metageneOnco = metaGene(OncoExpr,OncoClin,meta.method = 'FEM')

metageneRep['HMGCR',]
metageneROS['PMVK',]
metageneOnco['PMVK',]

metageneRep['TP53',]
metageneROS['TP53',]
metageneOnco['TP53',]
```

# 11 all matrix

```{r}
sentypes
allexpr = data.frame()
k = 0
for(i in 1:length(sentypes)){
  xexpr = get(paste0(sentypes[i],'Expr'))
  xclin = get(paste0(sentypes[i],'Clin'))
  tmpstudyname = names(xexpr)
  for(j in 1:length(xexpr)){
    tmp = as.data.frame(xexpr[[j]])
    ageType = xclin[[j]]$ageType
    colnames(tmp) = paste0(sentypes[i],'_',ageType,'_',tmpstudyname[j],'_',colnames(tmp))
    if(k == 0){
      allexpr = tmp
      k = k+1
    }else{
      tnames = union(rownames(allexpr),rownames(tmp))
      allexpr = cbind(allexpr[tnames,],tmp[tnames,])
      rownames(allexpr) = tnames
      k = k+1
    }
  }
}
allexpr[is.na(allexpr)] = 0
writetxt_forGPMM(allexpr,'./data/all_fpkm_from_paper_for_GPMM.txt')
```

```{r}
#standriazed
sentypes
allexpr = data.frame()
k = 0
for(i in 1:length(sentypes)){
  xexpr = get(paste0(sentypes[i],'Expr'))
  xclin = get(paste0(sentypes[i],'Clin'))
  tmpstudyname = names(xexpr)
  for(j in 1:length(xexpr)){
    tmpexprstd = expr_standardization(xexpr[[j]])
    tmp = as.data.frame(tmpexprstd)
    ageType = xclin[[j]]$ageType
    colnames(tmp) = paste0(sentypes[i],'_',ageType,'_',tmpstudyname[j],'_',colnames(tmp))
    if(k == 0){
      allexpr = tmp
      k = k+1
    }else{
      tnames = union(rownames(allexpr),rownames(tmp))
      allexpr = cbind(allexpr[tnames,],tmp[tnames,])
      rownames(allexpr) = tnames
      k = k+1
    }
  }
}
allexpr[is.na(allexpr)] = 0
writetxt_forGPMM(allexpr,'./data/all_fpkm_from_paper_for_GPMM_standardizated.txt')
```
